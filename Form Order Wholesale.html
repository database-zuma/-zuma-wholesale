<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Order - Google Sheets Sync</title>
    
    <!-- jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        /* Same styles as Form_Order_Master_Data.html */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1F4E78 0%, #2E75B5 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .badge {
            display: inline-block;
            background: #70AD47;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }
        .loading-indicator {
            display: none;
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        .form-section { padding: 30px; }
        .section-title {
            font-size: 20px;
            color: #1F4E78;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2E75B5;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group.full-width { grid-column: 1 / -1; }
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2E75B5;
        }
        input:disabled, select:disabled {
            background: #f5f5f5;
            color: #666;
        }
        .order-items { margin-top: 20px; }
        /* Item form inputs - prevent text truncation */
        .item-name {
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }
        .item-name:hover, .item-name:focus {
            white-space: normal;
            overflow: visible;
            position: relative;
            z-index: 10;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .order-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            position: relative;
        }
        .order-item h4 {
            color: #1F4E78;
            margin-bottom: 15px;
        }
        .sku-search-container {
            position: relative;
            margin-bottom: 15px;
        }
        .sku-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #2E75B5;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .sku-suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s;
        }
        .sku-suggestion-item:hover { background: #f0f7ff; }
        .sku-suggestion-item:last-child { border-bottom: none; }
        .sku-code {
            font-weight: bold;
            color: #1F4E78;
        }
        .sku-details {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .stock-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        .stock-available { background: #d4edda; color: #155724; }
        .stock-low { background: #fff3cd; color: #856404; }
        .stock-out { background: #f8d7da; color: #721c24; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-add {
            background: #70AD47;
            color: white;
            margin-top: 10px;
        }
        .btn-add:hover { background: #5a8c38; }
        .btn-remove {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        .btn-remove:hover { background: #c82333; }
        .signature-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        .signature-pad-container {
            border: 2px solid #2E75B5;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        .signature-pad-container h4 {
            color: #1F4E78;
            margin-bottom: 10px;
        }
        canvas {
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: white;
            cursor: crosshair;
            touch-action: none;
            width: 100%;
        }
        .signature-controls {
            margin-top: 10px;
            text-align: center;
        }
        .btn-clear {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }
        .btn-clear:hover { background: #5a6268; }
        .submit-section {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            border-top: 2px solid #e0e0e0;
        }
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            font-size: 18px;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .total-section {
            background: #FFFFCC;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #f0c419;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .total-row:last-child {
            margin-bottom: 0;
            font-size: 20px;
            font-weight: bold;
            color: #1F4E78;
            padding-top: 10px;
            border-top: 2px solid #daa520;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .info-box strong { color: #004085; }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .item-row { grid-template-columns: 1fr; }
            .signature-section { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- LOGIN MODAL -->
    <div id="loginOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 99999; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); width: 100%; max-width: 400px; margin: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #1F4E78; margin: 0;">üîê Login</h1>
                <p style="color: #666; margin-top: 10px;">Form Order Wholesale</p>
            </div>
            <div id="loginError" style="display: none; background: #f8d7da; color: #721c24; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center;"></div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Username</label>
                <input type="text" id="loginUsername" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" placeholder="Masukkan username" autocomplete="username">
            </div>
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Password</label>
                <input type="password" id="loginPassword" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" placeholder="Masukkan password" autocomplete="current-password">
            </div>
            <button type="button" onclick="doLogin()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #1F4E78 0%, #2E75B5 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                Masuk
            </button>
            <p style="text-align: center; margin-top: 20px; font-size: 12px; color: #999;">
                Hubungi Admin untuk mendapatkan akun
            </p>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="mainApp" style="display: none;">
    <div class="container">
        <div class="header" style="padding: 20px 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <img src="ZUMA_FINAL LOGO_UPDATED-04.png" alt="ZUMA Logo" style="height: 150px; filter: brightness(0) invert(1);">
                </div>
                <div style="text-align: center; flex: 2;">
                    <h1 style="font-size: 20px; margin: 0; font-weight: bold; letter-spacing: 1px;">FORM ORDER WHOLESALE</h1>
                    <span class="badge" style="margin-top: 8px;">Google Sheets Sync</span>
                </div>
                <div style="text-align: right; flex: 1;">
                    <div id="userInfo" style="font-size: 12px; margin-bottom: 8px;"></div>
                    <button onclick="doLogout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5); padding: 6px 16px; border-radius: 5px; cursor: pointer; font-size: 12px;">Logout</button>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <div id="alert" class="alert"></div>
            <div id="loadingIndicator" class="loading-indicator">
                ‚è≥ Loading master data dari Google Sheets...
            </div>
            
            <div class="info-box">
                <strong>üí° LIVE SYNC:</strong> Data produk di-load langsung dari Google Sheets. Ketik SKU untuk mencari produk!
                <br><small id="dataInfo" style="color: #666;"></small>
                <span id="logoIndicator" style="float: right; font-size: 11px; color: #666;">‚è≥ Logo...</span>
            </div>

            <!-- Hidden image untuk load logo -->
            <img id="logoImage" src="jj.png" style="display: none;" alt="Logo">
            
            <form id="orderForm">
                <!-- INFORMASI DOKUMEN -->
                <div class="section-title">üìÑ Informasi Dokumen</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tanggal">Tanggal *</label>
                        <input type="date" id="tanggal" required>
                    </div>
                    <div class="form-group">
                        <label for="noFO">No. Form Order *</label>
                        <input type="text" id="noFO" readonly style="background: #e8f4e8; font-weight: bold;">
                    </div>
                </div>
                
                <!-- INFORMASI CUSTOMER -->
                <div class="section-title">üë§ Informasi Customer</div>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="namaToko">Nama Customer *</label>
                        <input type="text" id="namaToko" placeholder="Nama lengkap customer" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="alamat">Alamat *</label>
                        <textarea id="alamat" rows="2" placeholder="Jl. Raya No. 123..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="provinsi">Provinsi *</label>
                        <select id="provinsi" required onchange="updateKabupaten()">
                            <option value="">Pilih Provinsi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="kabupaten">Kabupaten/Kota *</label>
                        <select id="kabupaten" required onchange="updateKecamatan()">
                            <option value="">Pilih Kabupaten/Kota</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="kecamatan">Kecamatan *</label>
                        <select id="kecamatan" required>
                            <option value="">Pilih Kecamatan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hp">No. HP *</label>
                        <input type="tel" id="hp" placeholder="08123456789" required>
                    </div>
                </div>
                
                <!-- ORDER ITEMS -->
                <div class="section-title">üõí Detail Order</div>
                <div id="orderItems" class="order-items"></div>
                <button type="button" class="btn btn-add" onclick="addOrderItem()">+ Tambah Item</button>
                
                <!-- TOTAL -->
                <div class="total-section">
                    <div class="total-row">
                        <span>Total Items:</span>
                        <span id="totalItems">0 Items</span>
                    </div>
                    <div class="total-row">
                        <span>Total Qty:</span>
                        <span id="totalQty">0 Box</span>
                    </div>
                    <div class="total-row">
                        <span>TOTAL AMOUNT:</span>
                        <span id="totalAmount">Rp 0</span>
                    </div>
                </div>
                
                <!-- SIGNATURE PADS -->
                <div class="signature-section" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; align-items: stretch;">
                    <!-- Customer -->
                    <div class="signature-pad-container" style="border-color: #27ae60; background: #f0fff0; display: flex; flex-direction: column;">
                        <h4 style="color: #27ae60; min-height: 45px; display: flex; align-items: center; justify-content: center;">‚úçÔ∏è Customer <span style="color: #e74c3c;">*</span></h4>
                        <canvas id="signatureCustomer" width="250" height="120" style="width: 100%;"></canvas>
                        <div class="signature-controls" style="min-height: 40px; display: flex; align-items: center; justify-content: center;">
                            <button type="button" class="btn btn-clear" onclick="clearSignature('customer')">Hapus</button>
                        </div>
                        <div style="margin-top: auto; padding-top: 10px;">
                            <input type="text" id="customerSignName" placeholder="Nama Customer" style="width: 100%; padding: 8px; border: 1px solid #27ae60; border-radius: 4px; text-align: center; font-weight: 600;">
                        </div>
                    </div>
                    <!-- SPV Wholesale -->
                    <div class="signature-pad-container" style="border-color: #95a5a6; background: #f5f5f5; opacity: 0.7; display: flex; flex-direction: column;">
                        <h4 style="color: #95a5a6; min-height: 45px; display: flex; align-items: center; justify-content: center;">üîí SPV Wholesale</h4>
                        <canvas id="signatureSPV" width="250" height="120" style="background: #eee; cursor: not-allowed; width: 100%;"></canvas>
                        <div class="signature-controls" style="min-height: 40px; display: flex; align-items: center; justify-content: center;">
                            <small style="color: #999;">TTD dari Arsip Order</small>
                        </div>
                        <div style="margin-top: auto; padding-top: 10px;">
                            <input type="text" id="spvSignName" value="Ni Luh Kade Yuliani" readonly style="width: 100%; padding: 8px; border: 1px solid #95a5a6; border-radius: 4px; text-align: center; font-weight: 600; background: #eee; color: #666;">
                        </div>
                    </div>
                    <!-- Branch Manager -->
                    <div class="signature-pad-container" style="border-color: #95a5a6; background: #f5f5f5; opacity: 0.7; display: flex; flex-direction: column;">
                        <h4 style="color: #95a5a6; min-height: 45px; display: flex; align-items: center; justify-content: center; text-align: center;">üîí Branch Manager</h4>
                        <canvas id="signatureManager" width="250" height="120" style="background: #eee; cursor: not-allowed; width: 100%;"></canvas>
                        <div class="signature-controls" style="min-height: 40px; display: flex; align-items: center; justify-content: center;">
                            <small style="color: #999;">TTD dari Arsip Order</small>
                        </div>
                        <div style="margin-top: auto; padding-top: 10px;">
                            <input type="text" id="managerSignName" value="Budy" readonly style="width: 100%; padding: 8px; border: 1px solid #95a5a6; border-radius: 4px; text-align: center; font-weight: 600; background: #eee; color: #666;">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="submit-section">
            <button type="button" class="btn btn-submit" onclick="saveOrder()" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">üíæ Simpan Order</button>
            <button type="button" class="btn" style="background: #3498db; color: white; margin-left: 10px;" onclick="showArchive()">üìã Lihat Arsip Order</button>
            <button type="button" id="adminBtn" class="btn" style="background: #9b59b6; color: white; margin-left: 10px; display: none;" onclick="openAdminPanel()">üëë Admin</button>
        </div>

        <!-- ARCHIVE MODAL -->
        <div id="archiveModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; overflow-y: auto;">
            <div style="max-width: 900px; margin: 30px auto; background: white; border-radius: 15px; padding: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #1F4E78; margin: 0;">üìã Arsip Form Order</h2>
                    <div>
                        <button onclick="openTrash()" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-right: 10px;">üóëÔ∏è Sampah</button>
                        <button onclick="closeArchive()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">‚úï Tutup</button>
                    </div>
                </div>
                <div style="margin-bottom: 15px;" id="filterButtons">
                    <button onclick="filterArchive('all')" id="filterAll" class="filter-btn filter-active" style="display: inline-block; padding: 8px 15px; background: #3498db; color: white; border-radius: 5px; margin-right: 8px; border: 2px solid #3498db; cursor: pointer; font-weight: bold;">üìã Semua</button>
                    <button onclick="filterArchive('pending')" id="filterPending" class="filter-btn" style="display: inline-block; padding: 8px 15px; background: #fff3cd; color: #856404; border-radius: 5px; margin-right: 8px; border: 2px solid #fff3cd; cursor: pointer;">üü° Menunggu TTD</button>
                    <button onclick="filterArchive('complete')" id="filterComplete" class="filter-btn" style="display: inline-block; padding: 8px 15px; background: #d4edda; color: #155724; border-radius: 5px; border: 2px solid #d4edda; cursor: pointer;">üü¢ Lengkap</button>
                </div>
                <div id="filterInfo" style="margin-bottom: 10px; font-size: 13px; color: #666;"></div>
                <div id="archiveList" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- TRASH MODAL -->
        <div id="trashModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; overflow-y: auto;">
            <div style="max-width: 900px; margin: 30px auto; background: white; border-radius: 15px; padding: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #6c757d; margin: 0;">üóëÔ∏è Sampah</h2>
                    <div>
                        <button onclick="emptyTrash()" style="background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-right: 10px;">üî• Kosongkan Sampah</button>
                        <button onclick="closeTrash()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">‚úï Tutup</button>
                    </div>
                </div>
                <div id="trashInfo" style="margin-bottom: 10px; font-size: 13px; color: #666;"></div>
                <div id="trashList" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- ADMIN MODAL -->
        <div id="adminModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; overflow-y: auto;">
            <div style="max-width: 800px; margin: 30px auto; background: white; border-radius: 15px; padding: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #9b59b6; margin: 0;">üëë Admin Panel - Kelola User</h2>
                    <button onclick="closeAdminPanel()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">‚úï Tutup</button>
                </div>

                <!-- Add User Form -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">‚ûï Tambah User Baru</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="newUsername" placeholder="Username" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <input type="password" id="newPassword" placeholder="Password" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <input type="text" id="newName" placeholder="Nama Lengkap" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <select id="newRole" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">-- Pilih Role --</option>
                            <option value="customer">Customer</option>
                            <option value="spv">SPV Wholesale</option>
                            <option value="manager">Branch Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button onclick="addUser()" style="margin-top: 15px; background: #27ae60; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold;">‚ûï Tambah User</button>
                </div>

                <!-- User List -->
                <div>
                    <h4 style="margin: 0 0 15px 0; color: #333;">üìã Daftar User</h4>
                    <div id="userList" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- ORDER DETAIL MODAL (untuk TTD SPV/Manager) -->
        <div id="orderDetailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;">
            <div style="max-width: 900px; margin: 20px auto; background: white; border-radius: 8px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); position: relative;">

                <!-- Close Button (Top Right) -->
                <button onclick="closeOrderDetail()" style="position: absolute; right: 15px; top: 15px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5); padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; z-index: 1;">‚úï Tutup</button>

                <!-- Header -->
                <div style="background: linear-gradient(135deg, #1F4E78 0%, #2E6B9E 100%); color: white; padding: 20px 30px; border-radius: 8px 8px 0 0; text-align: center;">
                    <h2 style="margin: 0 0 5px 0; font-size: 20px; font-weight: bold;">FORM ORDER WHOLESALE</h2>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;"><span id="detailNoFO"></span></p>
                </div>

                <!-- Content Area -->
                <div style="padding: 25px 30px;">

                    <!-- Document Info Row -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding: 12px 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #333;">
                        <div><strong>Tanggal:</strong> <span id="detailTanggal"></span></div>
                    </div>

                    <!-- Info Customer Section -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #333; margin: 0 0 12px 0; font-size: 14px; text-transform: uppercase; border-bottom: 1px solid #ddd; padding-bottom: 8px;">Informasi Customer</h4>
                        <table style="width: 100%; font-size: 13px; color: #333;">
                            <tr>
                                <td style="width: 120px; padding: 5px 0;">Nama Customer</td>
                                <td style="padding: 5px 0;">: <span id="detailCustomer"></span></td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 0;">Alamat</td>
                                <td style="padding: 5px 0;">: <span id="detailAlamat"></span></td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 0;">No. HP</td>
                                <td style="padding: 5px 0;">: <span id="detailHP"></span></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Order Items Section -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #333; margin: 0 0 12px 0; font-size: 14px; text-transform: uppercase; border-bottom: 1px solid #ddd; padding-bottom: 8px;">Detail Order</h4>
                        <div id="detailOrderItems" style="overflow-x: auto;"></div>

                    </div>

                    <!-- Grand Total -->
                    <div style="margin-bottom: 20px; padding: 10px 15px; background: #f8f9fa; border-top: 1px solid #ddd;">
                        <div style="display: flex; justify-content: flex-end; align-items: center;">
                            <span style="font-size: 11px; color: #333; margin-right: 10px;">GRAND TOTAL:</span>
                            <span style="font-size: 13px; font-weight: bold; color: #333;" id="detailTotal"></span>
                        </div>
                    </div>

                    <!-- Status Approval (Compact) -->
                    <div style="background: #f8f9fa; padding: 12px 20px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ddd;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 30px;">
                            <span style="font-weight: bold; color: #333; font-size: 13px;">Status Approval:</span>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="text-align: center;">
                                    <span id="statusCustomer" style="font-size: 20px;">‚è≥</span>
                                    <div style="font-size: 10px; color: #333;">Customer</div>
                                </div>
                                <span style="color: #999;">‚Üí</span>
                                <div style="text-align: center;">
                                    <span id="statusSPV" style="font-size: 20px;">‚è≥</span>
                                    <div style="font-size: 10px; color: #333;">SPV</div>
                                </div>
                                <span style="color: #999;">‚Üí</span>
                                <div style="text-align: center;">
                                    <span id="statusManager" style="font-size: 20px;">‚è≥</span>
                                    <div style="font-size: 10px; color: #333;">Manager</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Company Selection Section (SPV Only) -->
                    <div id="companySelectionSection" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                        <h4 style="color: #333; margin: 0 0 12px 0; font-size: 14px; text-transform: uppercase;">Pilihan Entitas Perusahaan</h4>

                        <!-- Company Selector - Only visible when SPV belum TTD -->
                        <div id="companySelector" style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; cursor: pointer; padding: 10px 15px; background: white; border: 2px solid #ddd; border-radius: 6px; flex: 1; min-width: 200px;">
                                <input type="radio" name="companyChoice" value="UBB" checked style="margin-right: 10px; transform: scale(1.2);">
                                <div>
                                    <div style="font-weight: bold; color: #1F4E78;">UBB</div>
                                    <div style="font-size: 11px; color: #666;">CV. Untung Besar Bersama</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; padding: 10px 15px; background: white; border: 2px solid #ddd; border-radius: 6px; flex: 1; min-width: 200px;">
                                <input type="radio" name="companyChoice" value="MBB" style="margin-right: 10px; transform: scale(1.2);">
                                <div>
                                    <div style="font-weight: bold; color: #2E7D32;">MBB</div>
                                    <div style="font-size: 11px; color: #666;">CV. Makmur Besar Bersama</div>
                                </div>
                            </label>
                        </div>

                        <!-- Company Display - Only visible when SPV sudah TTD -->
                        <div id="companyDisplay" style="display: none; padding: 10px 15px; background: white; border-radius: 6px; border: 2px solid #333;">
                            <span style="font-size: 13px;"><strong>Entitas:</strong> <span id="selectedCompanyText"></span></span>
                        </div>

                        <p id="companyNote" style="margin: 10px 0 0 0; font-size: 11px; color: #666;">* SPV menentukan entitas perusahaan saat tanda tangan</p>
                    </div>

                    <!-- Signature Section (PDF-Style) -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #333; margin: 0 0 15px 0; font-size: 14px; text-transform: uppercase; border-bottom: 1px solid #ddd; padding-bottom: 8px;">Tanda Tangan</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">

                            <!-- Customer Signature -->
                            <div style="border: 1px solid #333; border-radius: 8px; overflow: hidden;">
                                <div style="background: #333; color: white; padding: 8px; text-align: center; font-size: 12px; font-weight: bold;">
                                    Customer
                                </div>
                                <div style="padding: 15px; background: #fafafa;">
                                    <div id="detailSigCustomer" style="background: white; border: 1px solid #ddd; border-radius: 4px; height: 80px; display: flex; align-items: center; justify-content: center;">
                                        <img id="imgSigCustomer" style="max-width: 100%; max-height: 80px;">
                                    </div>
                                    <p id="detailNameCustomer" style="text-align: center; font-weight: bold; margin: 10px 0 0 0; font-size: 13px; color: #333;"></p>
                                </div>
                            </div>

                            <!-- SPV Signature -->
                            <div id="spvSignatureContainer" style="border: 1px solid #333; border-radius: 8px; overflow: hidden;">
                                <div id="spvSignatureHeader" style="background: #333; color: white; padding: 8px; text-align: center; font-size: 12px; font-weight: bold;">
                                    SPV Wholesale
                                </div>
                                <div style="padding: 15px; background: #fafafa;">
                                    <div id="detailSigSPVDisplay" style="display: none; background: white; border: 1px solid #ddd; border-radius: 4px; height: 80px;">
                                        <img id="imgSigSPV" style="max-width: 100%; max-height: 80px;">
                                    </div>
                                    <div id="detailSigSPVInput" style="display: block;">
                                        <canvas id="signatureSPVDetail" width="220" height="80" style="border: 1px dashed #ccc; border-radius: 4px; background: white; width: 100%; cursor: crosshair;"></canvas>
                                        <div style="margin-top: 8px; text-align: center;">
                                            <button type="button" onclick="clearDetailSignature('spv')" style="background: #6c757d; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 5px;">Hapus</button>
                                            <button type="button" id="btnSignSPV" onclick="signAsSPV()" style="background: #333; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">TTD SPV</button>
                                        </div>
                                    </div>
                                    <p style="text-align: center; font-weight: bold; margin: 10px 0 0 0; font-size: 13px; color: #333;">Ni Luh Kade Yuliani</p>
                                </div>
                            </div>

                            <!-- Manager Signature -->
                            <div id="managerSignatureContainer" style="border: 1px solid #333; border-radius: 8px; overflow: hidden;">
                                <div id="managerSignatureHeader" style="background: #333; color: white; padding: 8px; text-align: center; font-size: 12px; font-weight: bold;">
                                    Branch Manager
                                </div>
                                <div style="padding: 15px; background: #fafafa;">
                                    <div id="detailSigManagerDisplay" style="display: none; background: white; border: 1px solid #ddd; border-radius: 4px; height: 80px;">
                                        <img id="imgSigManager" style="max-width: 100%; max-height: 80px;">
                                    </div>
                                    <div id="detailSigManagerInput" style="display: block;">
                                        <canvas id="signatureManagerDetail" width="220" height="80" style="border: 1px dashed #ccc; border-radius: 4px; background: white; width: 100%; cursor: crosshair;"></canvas>
                                        <div style="margin-top: 8px; text-align: center;">
                                            <button type="button" onclick="clearDetailSignature('manager')" style="background: #6c757d; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 5px;">Hapus</button>
                                            <button type="button" id="btnSignManager" onclick="signAsManager()" style="background: #333; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;" disabled>TTD Manager</button>
                                        </div>
                                        <p id="managerWaitMessage" style="font-size: 10px; color: #e74c3c; text-align: center; margin-top: 5px;">Menunggu TTD SPV</p>
                                    </div>
                                    <p style="text-align: center; font-weight: bold; margin: 10px 0 0 0; font-size: 13px; color: #333;">Budy</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Action Buttons Footer -->
                <div style="background: #f5f5f5; padding: 20px 30px; border-radius: 0 0 8px 8px; border-top: 1px solid #ddd;">
                    <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <div id="pdfButtonArea">
                            <button type="button" id="btnRegeneratePDF" onclick="regeneratePDF()" style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 8px rgba(76,175,80,0.3);">
                                üìÑ Generate PDF
                            </button>
                            <p id="pdfWarning" style="color: #e74c3c; font-size: 11px; margin-top: 8px; display: none; text-align: center;">
                                ‚ö†Ô∏è Lengkapi semua TTD untuk generate PDF
                            </p>
                        </div>
                        <button type="button" id="btnDeleteOrderDetail" onclick="deleteOrderFromDetail()" style="background: linear-gradient(135deg, #ef5350 0%, #c62828 100%); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 8px rgba(239,83,80,0.3);">
                            üóëÔ∏è Hapus Order
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- IMAGE ZOOM MODAL -->
        <div id="imageZoomModal" onclick="closeImageZoom(event)" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10001; cursor: pointer; display: none; justify-content: center; align-items: center;">
            <div style="position: relative; max-width: 90vw; max-height: 90vh;">
                <button onclick="closeImageZoom()" style="position: absolute; top: -40px; right: 0; background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">‚úï Tutup</button>
                <img id="zoomImage" src="" alt="Product Image" style="max-width: 90vw; max-height: 85vh; object-fit: contain; border-radius: 8px; box-shadow: 0 0 30px rgba(255,255,255,0.3);">
                <p id="zoomImageCaption" style="color: white; text-align: center; margin-top: 15px; font-size: 16px; font-weight: bold;"></p>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // GOOGLE SHEETS CONFIGURATION
        // ========================================

        // PASTE PUBLISHED GOOGLE SHEETS CSV URL HERE:
        const GOOGLE_SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSOWaNo-hDRWdP1u_czDNR55PvrAByQqGpMV1WgXPSdfs-PGVxc2-vyGEdXkuFEGNTjONdrWIpwmrOv/pub?gid=1738516088&single=true&output=csv';
        // CORS Proxy untuk akses dari file lokal
        const GOOGLE_SHEET_URL = 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(GOOGLE_SHEET_CSV);

        // ========================================
        // IMAGE DATA SHEET (Sheet terpisah untuk URL gambar)
        // ========================================
        // PASTE PUBLISHED IMAGE DATA CSV URL HERE (sheet dengan kolom: SKU | ImageURL):
        const IMAGE_DATA_CSV = 'PASTE_IMAGE_DATA_CSV_URL_HERE';
        const IMAGE_DATA_URL = 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(IMAGE_DATA_CSV);
        let imageDataMap = {}; // SKU -> ImageURL mapping

        // ========================================
        // LOGO CONFIGURATION (Base64 Embedded)
        // ========================================
        let logoBase64 = null; // UBB logo
        let logoMBB = null; // MBB logo

        // Company Info Configuration
        const COMPANY_INFO = {
            UBB: {
                name: 'CV. UNTUNG BESAR BERSAMA',
                address1: 'Kahuripan Park 1-09, Desa Sumput,',
                address2: 'Kec. Sidoarjo, Kab. Sidoarjo,',
                address3: 'Jawa Timur, Indonesia',
                email: 'Email: untungbesarbersama@gmail.com',
                logoKey: 'fo_logo_base64'
            },
            MBB: {
                name: 'CV. MAKMUR BESAR BERSAMA',
                address1: 'Perum AURI Jalan Avia No. 178,',
                address2: 'Kel. Lemahputro, Kec. Sidoarjo,',
                address3: 'Kab. Sidoarjo, Jawa Timur',
                email: 'Email: cvmakmurbesarbersama@gmail.com',
                logoKey: 'fo_logo_mbb_base64'
            }
        };

        function loadLogo() {
            // Load UBB Logo
            const cachedLogo = localStorage.getItem('fo_logo_base64');
            if (cachedLogo) {
                logoBase64 = cachedLogo;
                console.log('‚úÖ Logo UBB loaded from cache');
            } else {
                console.log('‚ö†Ô∏è Logo UBB tidak ditemukan. Setup via setup-logo.html');
            }

            // Load MBB Logo
            const cachedLogoMBB = localStorage.getItem('fo_logo_mbb_base64');
            if (cachedLogoMBB) {
                logoMBB = cachedLogoMBB;
                console.log('‚úÖ Logo MBB loaded from cache');
            } else {
                console.log('‚ö†Ô∏è Logo MBB tidak ditemukan. Setup via setup-logo-mbb.html');
            }

            updateLogoIndicator(cachedLogo ? true : false);

            // Coba load dari file sebagai fallback
            const img = document.getElementById('logoImage');

            // Method 1: Coba dari hidden image
            if (img && img.complete && img.naturalWidth > 0) {
                convertLogoToBase64(img);
                return;
            }

            // Method 2: Coba load ulang
            if (img) {
                img.onload = function() {
                    convertLogoToBase64(img);
                };
                img.onerror = function() {
                    // Method 3: Coba dengan fetch
                    loadLogoWithFetch();
                };
            } else {
                loadLogoWithFetch();
            }
        }

        function updateLogoIndicator(loaded) {
            const indicator = document.getElementById('logoIndicator');
            if (indicator) {
                if (loaded) {
                    indicator.innerHTML = '‚úÖ Logo';
                    indicator.style.color = '#27ae60';
                } else {
                    indicator.innerHTML = '‚ö†Ô∏è <a href="setup-logo.html" target="_blank" style="color: #e74c3c;">Setup Logo</a>';
                    indicator.style.color = '#e74c3c';
                }
            }
        }

        function loadLogoWithFetch() {
            fetch('jj.png')
                .then(response => response.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        logoBase64 = reader.result;
                        saveLogo(logoBase64);
                        updateLogoIndicator(true);
                        console.log('Logo loaded via fetch');
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(err => {
                    console.log('Fetch failed, trying XMLHttpRequest');
                    loadLogoWithXHR();
                });
        }

        function loadLogoWithXHR() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'jj.png', true);
            xhr.responseType = 'blob';
            xhr.onload = function() {
                if (xhr.status === 200 || xhr.status === 0) {
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        logoBase64 = reader.result;
                        saveLogo(logoBase64);
                        updateLogoIndicator(true);
                        console.log('Logo loaded via XHR');
                    };
                    reader.readAsDataURL(xhr.response);
                }
            };
            xhr.onerror = function() {
                console.log('All methods failed, PDF will use text header');
                updateLogoIndicator(false);
            };
            xhr.send();
        }

        function convertLogoToBase64(img) {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                logoBase64 = canvas.toDataURL('image/png');
                saveLogo(logoBase64);
                updateLogoIndicator(true);
                console.log('Logo loaded successfully:', img.naturalWidth, 'x', img.naturalHeight);
            } catch (e) {
                console.log('Canvas conversion failed:', e);
                loadLogoWithFetch();
            }
        }

        function saveLogo(base64) {
            try {
                localStorage.setItem('fo_logo_base64', base64);
                console.log('Logo saved to cache');
            } catch (e) {
                console.log('Failed to cache logo:', e);
            }
        }
        
        // Example: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ.../pub?output=csv'
        
        // ========================================
        // MASTER DATA (Loaded from Google Sheets)
        // ========================================

        let masterDataSKU = [];

        // Load Image Data dari sheet terpisah
        async function loadImageData() {
            if (IMAGE_DATA_CSV === 'PASTE_IMAGE_DATA_CSV_URL_HERE') {
                console.log('‚ÑπÔ∏è Image Data URL belum dikonfigurasi. Foto produk tidak akan ditampilkan.');
                return;
            }

            try {
                const response = await fetch(IMAGE_DATA_URL);
                const csvText = await response.text();

                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        results.data.forEach(row => {
                            const sku = row.SKU || row.sku || '';
                            let imageUrl = row.ImageURL || row.imageUrl || row.Image || row.image ||
                                           row['Image URL'] || row.Foto || row.Gambar || '';

                            if (sku && imageUrl) {
                                // Convert Google Drive URL to thumbnail URL
                                if (imageUrl.includes('drive.google.com')) {
                                    let fileId = null;
                                    if (imageUrl.includes('/file/d/')) {
                                        fileId = imageUrl.match(/\/file\/d\/([^\/\?]+)/)?.[1];
                                    } else if (imageUrl.includes('id=')) {
                                        fileId = imageUrl.match(/id=([^&]+)/)?.[1];
                                    }
                                    if (fileId) {
                                        imageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w200`;
                                    }
                                }
                                imageDataMap[sku] = imageUrl;
                            }
                        });
                        console.log(`‚úÖ Loaded ${Object.keys(imageDataMap).length} gambar dari ImageData sheet`);
                    }
                });
            } catch (error) {
                console.log('‚ö†Ô∏è Gagal load Image Data:', error.message);
            }
        }

        // Load data from Google Sheets
        async function loadMasterData() {
            // Load image data terlebih dahulu
            await loadImageData();
            if (GOOGLE_SHEET_URL === 'PASTE_YOUR_GOOGLE_SHEETS_CSV_URL_HERE') {
                showAlert('‚ö†Ô∏è Google Sheets URL belum diisi! Edit file HTML dan paste URL di variable GOOGLE_SHEET_URL', 'error');
                document.getElementById('dataInfo').textContent = '‚ùå URL not configured';
                return;
            }
            
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        masterDataSKU = results.data.map(row => {
                            // Parse harga - remove dots/commas for Indonesian number format
                            let hargaStr = row.Harga || row.harga || '0';
                            let hargaClean = hargaStr.toString().replace(/[.,]/g, '');

                            // Convert Google Drive share URL to direct image URL
                            // Support berbagai nama kolom
                            let imageUrl = row.ImageURL || row.imageUrl || row.Image || row.image ||
                                           row['Image URL'] || row['image url'] || row.Foto || row.foto ||
                                           row.Gambar || row.gambar || row.Photo || row.photo || '';

                            // Debug: log untuk cek data
                            if (row.SKU === 'Z2MF01' || row.sku === 'Z2MF01') {
                                console.log('=== DEBUG Z2MF01 ===');
                                console.log('Raw row data:', row);
                                console.log('Image URL found:', imageUrl);
                                console.log('All columns:', Object.keys(row));
                            }

                            if (imageUrl && imageUrl.includes('drive.google.com')) {
                                // Handle berbagai format Google Drive URL
                                let fileId = null;

                                // Format: /file/d/FILE_ID/view
                                if (imageUrl.includes('/file/d/')) {
                                    fileId = imageUrl.match(/\/file\/d\/([^\/\?]+)/)?.[1];
                                }
                                // Format: ?id=FILE_ID
                                else if (imageUrl.includes('id=')) {
                                    fileId = imageUrl.match(/id=([^&]+)/)?.[1];
                                }
                                // Format: /open?id=FILE_ID
                                else if (imageUrl.includes('/open?')) {
                                    fileId = imageUrl.match(/id=([^&]+)/)?.[1];
                                }

                                if (fileId) {
                                    imageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w200`;
                                    console.log('Converted image URL:', imageUrl);
                                }
                            }

                            // Get SKU first for imageDataMap lookup
                            const productSku = row.SKU || row.sku || row.Code || row.code || '';

                            // Priority: imageDataMap (dari sheet ImageData) > imageUrl (dari FormOrderData)
                            const finalImageUrl = imageDataMap[productSku] || imageUrl;

                            if (imageDataMap[productSku]) {
                                console.log(`üñºÔ∏è ${productSku}: Menggunakan gambar dari ImageData sheet`);
                            }

                            return {
                                sku: productSku,
                                nama: row['Nama Produk'] || row.nama || row.Article || row.article || '',
                                series: row.Series || row.series || row.Tipe || row.tipe || '',
                                gender: row.Gender || row.gender || '',
                                harga: parseInt(hargaClean) || 0,
                                stock: parseInt(row.Stock || row.stock || 100), // Default 100 jika tidak ada
                                moq: parseInt(row.MOQ || row.moq || 1), // Default 1 jika tidak ada
                                imageUrl: finalImageUrl
                            };
                        }).filter(item => item.sku); // Only include rows with SKU
                        
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('dataInfo').textContent = `‚úÖ ${masterDataSKU.length} produk loaded dari Google Sheets`;
                        
                        if (masterDataSKU.length === 0) {
                            showAlert('‚ö†Ô∏è Tidak ada data produk. Check format Google Sheets Anda.', 'error');
                        } else {
                            showAlert(`‚úÖ Berhasil load ${masterDataSKU.length} produk!`, 'success');
                        }
                    },
                    error: function(error) {
                        document.getElementById('loadingIndicator').style.display = 'none';
                        showAlert('‚ùå Error loading data: ' + error.message, 'error');
                        document.getElementById('dataInfo').textContent = '‚ùå Error loading data';
                    }
                });
            } catch (error) {
                document.getElementById('loadingIndicator').style.display = 'none';
                showAlert('‚ùå Error connecting to Google Sheets: ' + error.message, 'error');
                document.getElementById('dataInfo').textContent = '‚ùå Connection error';
            }
        }
        
        // ========================================
        // INITIALIZATION
        // ========================================
        
        let itemCounter = 0;
        let signaturePadCustomer;
        let signaturePadSPV;
        let signaturePadManager;
        
        // Generate No. Form Order otomatis: FO-Wholesale-Zuma-DDMMYYYY-XXX
        function generateNoFO() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const dateKey = `${day}${month}${year}`;

            // Ambil nomor urut dari localStorage, reset jika tanggal berbeda
            const lastDate = localStorage.getItem('fo_last_date');
            let sequence = 1;

            if (lastDate === dateKey) {
                sequence = parseInt(localStorage.getItem('fo_sequence') || '0') + 1;
            }

            localStorage.setItem('fo_last_date', dateKey);
            localStorage.setItem('fo_sequence', sequence);

            return `FO-Wholesale-Zuma-${dateKey}-${String(sequence).padStart(3, '0')}`;
        }

        // Data Wilayah Indonesia (Provinsi -> Kabupaten -> Kecamatan)
        const dataWilayah = {
            "Aceh": {
                "Kota Banda Aceh": ["Baiturrahman", "Banda Raya", "Jaya Baru", "Kuta Alam", "Kuta Raja", "Lueng Bata", "Meuraxa", "Syiah Kuala", "Ulee Kareng"],
                "Kab. Aceh Besar": ["Darul Imarah", "Darul Kamal", "Indrapuri", "Kuta Baro", "Krueng Barona Jaya", "Mesjid Raya", "Montasik", "Peukan Bada", "Seulimeum", "Simpang Tiga"]
            },
            "Sumatera Utara": {
                "Kota Medan": ["Medan Amplas", "Medan Area", "Medan Barat", "Medan Baru", "Medan Belawan", "Medan Deli", "Medan Denai", "Medan Helvetia", "Medan Johor", "Medan Kota", "Medan Labuhan", "Medan Maimun", "Medan Marelan", "Medan Perjuangan", "Medan Petisah", "Medan Polonia", "Medan Selayang", "Medan Sunggal", "Medan Tembung", "Medan Timur", "Medan Tuntungan"],
                "Kab. Deli Serdang": ["Batang Kuis", "Beringin", "Deli Tua", "Galang", "Hamparan Perak", "Kutalimbaru", "Labuhan Deli", "Lubuk Pakam", "Namo Rambe", "Pancur Batu", "Patumbak", "Percut Sei Tuan", "Sibolangit", "Sunggal", "Tanjung Morawa"]
            },
            "Sumatera Barat": {
                "Kota Padang": ["Bungus Teluk Kabung", "Koto Tangah", "Kuranji", "Lubuk Begalung", "Lubuk Kilangan", "Nanggalo", "Padang Barat", "Padang Selatan", "Padang Timur", "Padang Utara", "Pauh"],
                "Kab. Padang Pariaman": ["Batang Anai", "Batang Gasan", "Enam Lingkung", "Lubuk Alung", "Nan Sabaris", "Padang Sago", "Patamuan", "Sintuk Toboh Gadang", "Sungai Geringging", "Sungai Limau", "Ulakan Tapakis"]
            },
            "Riau": {
                "Kota Pekanbaru": ["Bukit Raya", "Lima Puluh", "Marpoyan Damai", "Payung Sekaki", "Pekanbaru Kota", "Rumbai", "Rumbai Pesisir", "Sail", "Senapelan", "Sukajadi", "Tampan", "Tenayan Raya"],
                "Kab. Kampar": ["Bangkinang", "Bangkinang Kota", "Gunung Sahilan", "Kampar", "Kampar Kiri", "Kampar Timur", "Perhentian Raja", "Siak Hulu", "Tambang", "Tapung"]
            },
            "Jambi": {
                "Kota Jambi": ["Alam Barajo", "Danau Sipin", "Danau Teluk", "Jambi Selatan", "Jambi Timur", "Jelutung", "Kota Baru", "Paal Merah", "Pelayangan", "Telanaipura", "Pasar Jambi"],
                "Kab. Muaro Jambi": ["Jambi Luar Kota", "Jaluko", "Kumpeh", "Kumpeh Ulu", "Mestong", "Sekernan", "Sungai Bahar", "Sungai Gelam"]
            },
            "Sumatera Selatan": {
                "Kota Palembang": ["Alang-Alang Lebar", "Bukit Kecil", "Gandus", "Ilir Barat I", "Ilir Barat II", "Ilir Timur I", "Ilir Timur II", "Ilir Timur III", "Kalidoni", "Kemuning", "Kertapati", "Plaju", "Sako", "Seberang Ulu I", "Seberang Ulu II", "Sematang Borang", "Sukarami"],
                "Kab. Banyuasin": ["Banyuasin I", "Banyuasin II", "Banyuasin III", "Betung", "Makarti Jaya", "Muara Padang", "Muara Sugihan", "Muara Telang", "Pulau Rimau", "Rambutan", "Rantau Bayur", "Sembawa", "Suak Tapeh", "Talang Kelapa", "Tanjung Lago"]
            },
            "Bengkulu": {
                "Kota Bengkulu": ["Gading Cempaka", "Kampung Melayu", "Muara Bangkahulu", "Ratu Agung", "Ratu Samban", "Selebar", "Sungai Serut", "Singaran Pati", "Teluk Segara"],
                "Kab. Bengkulu Tengah": ["Bang Haji", "Karang Tinggi", "Merigi Kelindang", "Merigi Sakti", "Pagar Jati", "Pematang Tiga", "Pondok Kelapa", "Pondok Kubang", "Taba Penanjung", "Talang Empat"]
            },
            "Lampung": {
                "Kota Bandar Lampung": ["Bumi Waras", "Enggal", "Kedamaian", "Kedaton", "Kemiling", "Labuhan Ratu", "Langkapura", "Panjang", "Rajabasa", "Sukabumi", "Sukarame", "Tanjung Karang Barat", "Tanjung Karang Pusat", "Tanjung Karang Timur", "Tanjung Senang", "Teluk Betung Barat", "Teluk Betung Selatan", "Teluk Betung Timur", "Teluk Betung Utara", "Way Halim"],
                "Kab. Lampung Selatan": ["Bakauheni", "Candipuro", "Jati Agung", "Kalianda", "Katibung", "Ketapang", "Merbau Mataram", "Natar", "Palas", "Penengahan", "Rajabasa", "Sidomulyo", "Sragi", "Tanjung Bintang", "Tanjung Sari", "Way Panji", "Way Sulan"]
            },
            "Kepulauan Bangka Belitung": {
                "Kota Pangkal Pinang": ["Bukit Intan", "Gabek", "Gerunggang", "Girimaya", "Pangkal Balam", "Rangkui", "Taman Sari"],
                "Kab. Bangka": ["Bakam", "Belinyu", "Mendo Barat", "Merawang", "Pemali", "Puding Besar", "Riau Silip", "Sungailiat"]
            },
            "Kepulauan Riau": {
                "Kota Batam": ["Batam Kota", "Batu Aji", "Batu Ampar", "Belakang Padang", "Bengkong", "Bulang", "Galang", "Lubuk Baja", "Nongsa", "Sagulung", "Sei Beduk", "Sekupang"],
                "Kota Tanjung Pinang": ["Bukit Bestari", "Tanjungpinang Barat", "Tanjungpinang Kota", "Tanjungpinang Timur"]
            },
            "DKI Jakarta": {
                "Jakarta Pusat": ["Gambir", "Tanah Abang", "Menteng", "Senen", "Cempaka Putih", "Johar Baru", "Kemayoran", "Sawah Besar"],
                "Jakarta Utara": ["Penjaringan", "Pademangan", "Tanjung Priok", "Koja", "Kelapa Gading", "Cilincing"],
                "Jakarta Barat": ["Kembangan", "Kebon Jeruk", "Palmerah", "Grogol Petamburan", "Tambora", "Taman Sari", "Cengkareng", "Kalideres"],
                "Jakarta Selatan": ["Kebayoran Baru", "Kebayoran Lama", "Pesanggrahan", "Cilandak", "Pasar Minggu", "Jagakarsa", "Mampang Prapatan", "Pancoran", "Tebet", "Setiabudi"],
                "Jakarta Timur": ["Matraman", "Pulo Gadung", "Jatinegara", "Duren Sawit", "Kramat Jati", "Makasar", "Pasar Rebo", "Ciracas", "Cipayung", "Cakung"]
            },
            "Jawa Barat": {
                "Kota Bandung": ["Coblong", "Bandung Wetan", "Sumur Bandung", "Cibeunying Kaler", "Cibeunying Kidul", "Sukasari", "Sukajadi", "Cicendo", "Andir", "Cidadap", "Lengkong", "Batununggal", "Kiaracondong", "Antapani", "Arcamanik", "Ujungberung", "Cibiru", "Gedebage", "Rancasari", "Buahbatu"],
                "Kota Bekasi": ["Bekasi Timur", "Bekasi Barat", "Bekasi Utara", "Bekasi Selatan", "Rawalumbu", "Medan Satria", "Bantargebang", "Pondok Gede", "Jatiasih", "Jatisampurna", "Mustika Jaya", "Pondok Melati"],
                "Kota Bogor": ["Bogor Selatan", "Bogor Timur", "Bogor Utara", "Bogor Tengah", "Bogor Barat", "Tanah Sareal"],
                "Kota Depok": ["Beji", "Bojongsari", "Cilodong", "Cimanggis", "Cinere", "Cipayung", "Limo", "Pancoran Mas", "Sawangan", "Sukmajaya", "Tapos"],
                "Kab. Bogor": ["Cibinong", "Bojong Gede", "Cileungsi", "Gunung Putri", "Jonggol", "Parung", "Ciawi", "Cisarua", "Megamendung"],
                "Kab. Bandung": ["Cileunyi", "Rancaekek", "Bojongsoang", "Margahayu", "Margaasih", "Katapang", "Dayeuhkolot", "Banjaran", "Baleendah", "Soreang"],
                "Kab. Karawang": ["Karawang Barat", "Karawang Timur", "Cikampek", "Klari", "Purwasari", "Telukjambe Barat", "Telukjambe Timur"],
                "Kab. Sukabumi": ["Cicurug", "Cisaat", "Kadudampit", "Cibadak", "Parungkuda", "Sukabumi", "Sukaraja"]
            },
            "Jawa Tengah": {
                "Kota Semarang": ["Semarang Tengah", "Semarang Utara", "Semarang Timur", "Semarang Selatan", "Semarang Barat", "Gayamsari", "Genuk", "Pedurungan", "Tembalang", "Banyumanik", "Gunungpati", "Mijen", "Ngaliyan", "Candisari", "Gajahmungkur"],
                "Kota Solo": ["Laweyan", "Serengan", "Pasar Kliwon", "Jebres", "Banjarsari"],
                "Kab. Semarang": ["Ungaran Barat", "Ungaran Timur", "Bergas", "Pringapus", "Bawen", "Ambarawa", "Bandungan"],
                "Kab. Kudus": ["Kudus", "Jati", "Undaan", "Mejobo", "Jekulo", "Bae", "Gebog", "Dawe", "Kaliwungu"],
                "Kab. Demak": ["Demak", "Wonosalam", "Dempet", "Gajah", "Karanganyar", "Mijen", "Wedung", "Bonang", "Sayung"],
                "Kab. Kendal": ["Kendal", "Weleri", "Kaliwungu", "Boja", "Pegandon", "Ngampel", "Patebon", "Cepiring", "Rowosari"],
                "Kab. Pekalongan": ["Kajen", "Kedungwuni", "Buaran", "Tirto", "Wiradesa", "Bojong", "Kesesi", "Sragi", "Siwalan"],
                "Kab. Tegal": ["Slawi", "Adiwerna", "Dukuhturi", "Talang", "Tarub", "Kramat", "Suradadi", "Warureja", "Lebaksiu"],
                "Kab. Brebes": ["Brebes", "Bulakamba", "Wanasari", "Tanjung", "Losari", "Kersana", "Ketanggungan", "Banjarharjo", "Larangan"],
                "Kab. Cilacap": ["Cilacap Selatan", "Cilacap Tengah", "Cilacap Utara", "Kroya", "Majenang", "Sidareja", "Adipala", "Kesugihan", "Jeruklegi"],
                "Kab. Banyumas": ["Purwokerto Selatan", "Purwokerto Timur", "Purwokerto Barat", "Purwokerto Utara", "Sokaraja", "Kembaran", "Sumbang", "Baturaden", "Ajibarang"]
            },
            "DI Yogyakarta": {
                "Kota Yogyakarta": ["Danurejan", "Gedongtengen", "Gondokusuman", "Gondomanan", "Jetis", "Kotagede", "Kraton", "Mantrijeron", "Mergangsan", "Ngampilan", "Pakualaman", "Tegalrejo", "Umbulharjo", "Wirobrajan"],
                "Kab. Sleman": ["Depok", "Mlati", "Ngaglik", "Ngemplak", "Kalasan", "Prambanan", "Berbah", "Gamping", "Godean", "Moyudan", "Minggir", "Seyegan", "Tempel", "Turi", "Pakem", "Cangkringan", "Sleman"],
                "Kab. Bantul": ["Bantul", "Sewon", "Kasihan", "Banguntapan", "Pleret", "Piyungan", "Dlingo", "Imogiri", "Jetis", "Pandak", "Bambanglipuro", "Pundong", "Kretek", "Sanden", "Srandakan", "Pajangan", "Sedayu"],
                "Kab. Gunung Kidul": ["Wonosari", "Playen", "Patuk", "Nglipar", "Ngawen", "Semin", "Karangmojo", "Ponjong", "Rongkop", "Semanu", "Tepus", "Tanjungsari", "Saptosari", "Paliyan", "Girisubo", "Purwosari", "Panggang", "Gedangsari"],
                "Kab. Kulon Progo": ["Wates", "Panjatan", "Galur", "Lendah", "Sentolo", "Pengasih", "Kokap", "Girimulyo", "Nanggulan", "Samigaluh", "Kalibawang", "Temon"]
            },
            "Jawa Timur": {
                "Kab. Sidoarjo": ["Sidoarjo", "Candi", "Tanggulangin", "Porong", "Waru", "Gedangan", "Buduran", "Sedati", "Taman", "Sukodono", "Krian", "Balongbendo", "Tarik", "Prambon", "Krembung", "Tulangan", "Wonoayu", "Jabon"],
                "Kota Surabaya": ["Gubeng", "Tegalsari", "Genteng", "Bubutan", "Simokerto", "Semampir", "Kenjeran", "Tambaksari", "Sawahan", "Wonokromo", "Karangpilang", "Wiyung", "Wonocolo", "Gayungan", "Rungkut", "Sukolilo", "Mulyorejo", "Tandes", "Benowo", "Lakarsantri"],
                "Kota Malang": ["Klojen", "Blimbing", "Kedungkandang", "Sukun", "Lowokwaru"],
                "Kab. Malang": ["Singosari", "Lawang", "Pakis", "Tumpang", "Poncokusumo", "Jabung", "Pakisaji", "Kepanjen", "Gondanglegi", "Bululawang", "Dampit", "Turen", "Wajak", "Sumbermanjing"],
                "Kab. Gresik": ["Gresik", "Kebomas", "Manyar", "Duduksampeyan", "Cerme", "Benjeng", "Menganti", "Driyorejo", "Wringinanom"],
                "Kab. Mojokerto": ["Mojosari", "Pungging", "Ngoro", "Jetis", "Puri", "Sooko", "Gedeg", "Kemlagi", "Trowulan", "Dlanggu"],
                "Kab. Pasuruan": ["Pandaan", "Gempol", "Beji", "Bangil", "Rembang", "Kraton", "Gondangwetan", "Purwosari", "Sukorejo", "Winongan"],
                "Kab. Jombang": ["Jombang", "Diwek", "Perak", "Mojoagung", "Mojowarno", "Peterongan", "Sumobito", "Ngoro", "Bareng", "Bandarkedungmulyo"],
                "Kab. Lamongan": ["Lamongan", "Paciran", "Brondong", "Babat", "Sukodadi", "Pucuk", "Kedungpring", "Mantup", "Tikung", "Deket"],
                "Kab. Tuban": ["Tuban", "Palang", "Semanding", "Merakurak", "Kerek", "Tambakboyo", "Jenu", "Widang", "Plumpang", "Rengel"],
                "Kab. Bojonegoro": ["Bojonegoro", "Kapas", "Sumberrejo", "Balen", "Kanor", "Baureno", "Trucuk", "Dander", "Padangan", "Kasiman"],
                "Kab. Ngawi": ["Ngawi", "Paron", "Geneng", "Kwadungan", "Karangjati", "Widodaren", "Mantingan", "Sine", "Ngrambe", "Jogorogo"],
                "Kab. Madiun": ["Mejayan", "Caruban", "Wonoasri", "Balerejo", "Wungu", "Dagangan", "Dolopo", "Geger", "Sawahan", "Jiwan"],
                "Kab. Kediri": ["Pare", "Gurah", "Puncu", "Plosoklaten", "Wates", "Ngancar", "Mojo", "Semen", "Ngadiluwih", "Kras"],
                "Kab. Blitar": ["Kanigoro", "Talun", "Selopuro", "Kesamben", "Doko", "Wlingi", "Gandusari", "Garum", "Nglegok", "Sanankulon"],
                "Kab. Tulungagung": ["Tulungagung", "Kedungwaru", "Boyolangu", "Ngunut", "Sumbergempol", "Kalidawir", "Rejotangan", "Kauman", "Gondang", "Pagerwojo"],
                "Kab. Trenggalek": ["Trenggalek", "Pogalan", "Watulimo", "Kampak", "Munjungan", "Karangan", "Tugu", "Bendungan", "Dongko", "Pule"],
                "Kab. Ponorogo": ["Ponorogo", "Siman", "Mlarak", "Jetis", "Balong", "Slahung", "Ngrayun", "Bungkal", "Sambit", "Sawoo"],
                "Kab. Pacitan": ["Pacitan", "Kebonagung", "Arjosari", "Tulakan", "Ngadirojo", "Punung", "Pringkuku", "Donorojo", "Nawangan", "Bandar"],
                "Kab. Magetan": ["Magetan", "Maospati", "Bendo", "Takeran", "Kawedanan", "Plaosan", "Panekan", "Sukomoro", "Karangrejo", "Karas"],
                "Kab. Nganjuk": ["Nganjuk", "Bagor", "Wilangan", "Rejoso", "Gondang", "Sukomoro", "Lengkong", "Prambon", "Tanjunganom", "Baron"],
                "Kab. Jember": ["Kaliwates", "Sumbersari", "Patrang", "Ajung", "Rambipuji", "Balung", "Umbulsari", "Semboro", "Kencong", "Puger"],
                "Kab. Banyuwangi": ["Banyuwangi", "Giri", "Glagah", "Kalipuro", "Kabat", "Rogojampi", "Muncar", "Genteng", "Gambiran", "Srono"],
                "Kab. Bondowoso": ["Bondowoso", "Tenggarang", "Tapen", "Wonosari", "Tamanan", "Maesan", "Cermee", "Prajekan", "Klabang", "Pakem"],
                "Kab. Situbondo": ["Situbondo", "Panarukan", "Kendit", "Panji", "Mangaran", "Kapongan", "Mlandingan", "Bungatan", "Asembagus", "Jangkar"],
                "Kab. Probolinggo": ["Kraksaan", "Paiton", "Besuk", "Pajarakan", "Krejengan", "Maron", "Gending", "Dringu", "Tegalsiwalan", "Banyuanyar"],
                "Kab. Lumajang": ["Lumajang", "Sukodono", "Senduro", "Gucialit", "Padang", "Pasrujambe", "Klakah", "Ranuyoso", "Randuagung", "Kedungjajang"],
                "Kab. Sampang": ["Sampang", "Camplong", "Omben", "Kedungdung", "Jrengik", "Tambelangan", "Banyuates", "Robatal", "Sreseh", "Torjun"],
                "Kab. Pamekasan": ["Pamekasan", "Tlanakan", "Pademawu", "Galis", "Larangan", "Proppo", "Palengaan", "Pegantenan", "Kadur", "Pakong"],
                "Kab. Sumenep": ["Sumenep", "Kalianget", "Manding", "Talango", "Bluto", "Saronggi", "Giligenteng", "Pragaan", "Guluk-Guluk", "Ambunten"],
                "Kab. Bangkalan": ["Bangkalan", "Socah", "Burneh", "Kamal", "Arosbaya", "Klampis", "Sepulu", "Tanjungbumi", "Kokop", "Geger"]
            },
            "Banten": {
                "Kota Tangerang": ["Tangerang", "Karawaci", "Cibodas", "Jatiuwung", "Periuk", "Batuceper", "Neglasari", "Benda", "Cipondoh", "Pinang", "Ciledug", "Larangan", "Karang Tengah"],
                "Kota Tangerang Selatan": ["Serpong", "Serpong Utara", "Ciputat", "Ciputat Timur", "Pamulang", "Pondok Aren", "Setu"],
                "Kota Serang": ["Serang", "Cipocok Jaya", "Curug", "Kasemen", "Taktakan", "Walantaka"],
                "Kota Cilegon": ["Cibeber", "Cilegon", "Citangkil", "Ciwandan", "Grogol", "Jombang", "Pulomerak", "Purwakarta"],
                "Kab. Tangerang": ["Tigaraksa", "Cikupa", "Curug", "Kelapa Dua", "Legok", "Pagedangan", "Cisauk", "Pasar Kemis", "Balaraja", "Sepatan"],
                "Kab. Serang": ["Ciruas", "Kragilan", "Pontang", "Tirtayasa", "Tanara", "Cikande", "Kibin", "Carenang", "Binuang", "Petir"],
                "Kab. Pandeglang": ["Pandeglang", "Majasari", "Kaduhejo", "Banjar", "Cadasari", "Karangtanjung", "Labuan", "Carita", "Sumur", "Cibaliung"],
                "Kab. Lebak": ["Rangkasbitung", "Cibadak", "Warunggunung", "Cimarga", "Cipanas", "Sajira", "Maja", "Curugbitung", "Leuwidamar", "Muncang"]
            },
            "Bali": {
                "Kota Denpasar": ["Denpasar Barat", "Denpasar Timur", "Denpasar Selatan", "Denpasar Utara"],
                "Kab. Badung": ["Kuta", "Kuta Utara", "Kuta Selatan", "Mengwi", "Abiansemal", "Petang"],
                "Kab. Gianyar": ["Gianyar", "Ubud", "Tegallalang", "Tampaksiring", "Blahbatuh", "Sukawati", "Payangan"],
                "Kab. Tabanan": ["Tabanan", "Kediri", "Kerambitan", "Marga", "Penebel", "Baturiti", "Selemadeg"],
                "Kab. Buleleng": ["Buleleng", "Seririt", "Busungbiu", "Gerokgak", "Tejakula", "Kubutambahan", "Sawan", "Banjar", "Sukasada"],
                "Kab. Karangasem": ["Karangasem", "Abang", "Bebandem", "Kubu", "Manggis", "Rendang", "Selat", "Sidemen"],
                "Kab. Klungkung": ["Klungkung", "Banjarangkan", "Dawan", "Nusa Penida"],
                "Kab. Bangli": ["Bangli", "Susut", "Tembuku", "Kintamani"],
                "Kab. Jembrana": ["Negara", "Jembrana", "Mendoyo", "Pekutatan", "Melaya"]
            },
            "Nusa Tenggara Barat": {
                "Kota Mataram": ["Ampenan", "Cakranegara", "Mataram", "Sandubaya", "Sekarbela", "Selaparang"],
                "Kab. Lombok Barat": ["Gerung", "Kediri", "Kuripan", "Labuapi", "Lembar", "Lingsar", "Narmada", "Sekotong", "Gunungsari", "Batulayar"],
                "Kab. Lombok Tengah": ["Praya", "Praya Barat", "Praya Timur", "Janapria", "Batukliang", "Jonggat", "Kopang", "Pujut", "Pringgarata"],
                "Kab. Lombok Timur": ["Selong", "Labuhan Haji", "Pringgabaya", "Aikmel", "Masbagik", "Sakra", "Terara", "Montong Gading", "Sikur", "Sukamulia"],
                "Kab. Sumbawa": ["Sumbawa", "Labuhan Badas", "Unter Iwes", "Moyo Hilir", "Moyo Utara", "Lape", "Lopok", "Plampang", "Empang", "Tarano"],
                "Kab. Bima": ["Rasanae Barat", "Rasanae Timur", "Asakota", "Mpunda", "Raba"]
            },
            "Nusa Tenggara Timur": {
                "Kota Kupang": ["Alak", "Kelapa Lima", "Kota Lama", "Kota Raja", "Maulafa", "Oebobo"],
                "Kab. Kupang": ["Kupang Barat", "Kupang Tengah", "Kupang Timur", "Nekamese", "Taebenu", "Amarasi", "Fatuleu", "Takari", "Amabi Oefeto", "Sulamu"],
                "Kab. Flores Timur": ["Larantuka", "Ile Mandiri", "Tanjung Bunga", "Lewolema", "Titehena", "Wulanggitang", "Adonara", "Ile Boleng", "Witihama", "Kelubagolit"],
                "Kab. Sikka": ["Alok", "Alok Barat", "Alok Timur", "Nita", "Mego", "Lela", "Bola", "Talibura", "Waigete", "Kewapante"],
                "Kab. Ende": ["Ende Selatan", "Ende Tengah", "Ende Timur", "Ende Utara", "Nangapanda", "Ndona", "Wolowaru", "Detusoko", "Kelimutu", "Lio Timur"]
            },
            "Kalimantan Barat": {
                "Kota Pontianak": ["Pontianak Barat", "Pontianak Kota", "Pontianak Selatan", "Pontianak Tenggara", "Pontianak Timur", "Pontianak Utara"],
                "Kab. Kubu Raya": ["Sungai Raya", "Sungai Kakap", "Rasau Jaya", "Sungai Ambawang", "Terentang", "Kuala Mandor B", "Kubu", "Teluk Pakedai", "Batu Ampar"],
                "Kab. Mempawah": ["Mempawah Hilir", "Mempawah Timur", "Sungai Kunyit", "Sungai Pinyuh", "Anjongan", "Siantan", "Segedong", "Sadaniang", "Toho"]
            },
            "Kalimantan Tengah": {
                "Kota Palangkaraya": ["Pahandut", "Jekan Raya", "Bukit Batu", "Sabangau", "Rakumpit"],
                "Kab. Kotawaringin Timur": ["Sampit", "Baamang", "Mentawa Baru Ketapang", "Seranau", "Kota Besi", "Cempaga", "Cempaga Hulu", "Parenggean", "Mentaya Hulu", "Antang Kalang"],
                "Kab. Kotawaringin Barat": ["Pangkalan Bun", "Arut Selatan", "Kumai", "Pangkalan Lada", "Pangkalan Banteng", "Arut Utara"]
            },
            "Kalimantan Selatan": {
                "Kota Banjarmasin": ["Banjarmasin Barat", "Banjarmasin Selatan", "Banjarmasin Tengah", "Banjarmasin Timur", "Banjarmasin Utara"],
                "Kota Banjarbaru": ["Banjarbaru Selatan", "Banjarbaru Utara", "Cempaka", "Landasan Ulin", "Liang Anggang"],
                "Kab. Banjar": ["Martapura", "Martapura Barat", "Martapura Timur", "Karang Intan", "Astambul", "Gambut", "Kertak Hanyar", "Sungai Tabuk", "Aluh-Aluh", "Beruntung Baru"],
                "Kab. Tanah Laut": ["Pelaihari", "Takisung", "Jorong", "Batu Ampar", "Tambang Ulang", "Kurau", "Bajuin", "Bati-Bati", "Panyipatan", "Kintap"]
            },
            "Kalimantan Timur": {
                "Kota Samarinda": ["Samarinda Kota", "Samarinda Ilir", "Samarinda Seberang", "Samarinda Ulu", "Samarinda Utara", "Sungai Kunjang", "Sambutan", "Loa Janan Ilir", "Palaran", "Sungai Pinang"],
                "Kota Balikpapan": ["Balikpapan Barat", "Balikpapan Kota", "Balikpapan Selatan", "Balikpapan Tengah", "Balikpapan Timur", "Balikpapan Utara"],
                "Kab. Kutai Kartanegara": ["Tenggarong", "Tenggarong Seberang", "Loa Janan", "Loa Kulu", "Muara Badak", "Marang Kayu", "Samboja", "Muara Jawa", "Sanga-Sanga", "Anggana"],
                "Kab. Kutai Timur": ["Sangatta Utara", "Sangatta Selatan", "Bengalon", "Muara Ancalong", "Muara Bengkal", "Muara Wahau", "Batu Ampar", "Kombeng", "Rantau Pulung", "Teluk Pandan"],
                "Kab. Berau": ["Tanjung Redeb", "Gunung Tabur", "Sambaliung", "Teluk Bayur", "Segah", "Kelay", "Biduk-Biduk", "Batu Putih", "Biatan", "Tabalar"]
            },
            "Kalimantan Utara": {
                "Kota Tarakan": ["Tarakan Barat", "Tarakan Tengah", "Tarakan Timur", "Tarakan Utara"],
                "Kab. Bulungan": ["Tanjung Selor", "Tanjung Palas", "Tanjung Palas Barat", "Tanjung Palas Timur", "Tanjung Palas Tengah", "Tanjung Palas Utara", "Peso", "Peso Hilir", "Sekatak", "Bunyu"],
                "Kab. Malinau": ["Malinau Kota", "Malinau Barat", "Malinau Selatan", "Malinau Utara", "Mentarang", "Pujungan", "Kayan Hilir", "Kayan Hulu", "Kayan Selatan", "Bahau Hulu"]
            },
            "Sulawesi Utara": {
                "Kota Manado": ["Bunaken", "Malalayang", "Mapanget", "Sario", "Singkil", "Tikala", "Tuminting", "Wanea", "Wenang", "Paal Dua", "Bunaken Kepulauan"],
                "Kota Bitung": ["Aertembaga", "Girian", "Lembeh Selatan", "Lembeh Utara", "Madidir", "Maesa", "Matuari", "Ranowulu"],
                "Kab. Minahasa": ["Tondano Barat", "Tondano Selatan", "Tondano Timur", "Tondano Utara", "Eris", "Kakas", "Kakas Barat", "Kawangkoan", "Kawangkoan Barat", "Kawangkoan Utara"]
            },
            "Sulawesi Tengah": {
                "Kota Palu": ["Palu Barat", "Palu Selatan", "Palu Timur", "Palu Utara", "Mantikulore", "Tatanga", "Tawaeli", "Ulujadi"],
                "Kab. Donggala": ["Banawa", "Banawa Selatan", "Banawa Tengah", "Labuan", "Rio Pakava", "Sindue", "Sindue Tobata", "Sindue Tombusabora", "Sirenja", "Tanantovea"],
                "Kab. Parigi Moutong": ["Parigi", "Parigi Barat", "Parigi Selatan", "Parigi Tengah", "Parigi Utara", "Ampibabo", "Bolano", "Bolano Lambunu", "Kasimbar", "Mepanga"]
            },
            "Sulawesi Selatan": {
                "Kota Makassar": ["Biringkanaya", "Bontoala", "Makassar", "Mamajang", "Manggala", "Mariso", "Panakkukang", "Rappocini", "Tallo", "Tamalanrea", "Tamalate", "Ujung Pandang", "Ujung Tanah", "Wajo", "Kepulauan Sangkarrang"],
                "Kab. Gowa": ["Somba Opu", "Pallangga", "Barombong", "Bajeng", "Bajeng Barat", "Bontonompo", "Bontonompo Selatan", "Bontomarannu", "Pattallassang", "Parangloe", "Manuju", "Tinggimoncong", "Tombolo Pao", "Parigi", "Bungaya", "Bontolempangan", "Tompobulu", "Biringbulu"],
                "Kab. Maros": ["Maros Baru", "Turikale", "Mandai", "Moncongloe", "Marusu", "Bontoa", "Lau", "Tanralili", "Tompobulu", "Bantimurung", "Simbang", "Cenrana", "Camba", "Mallawa"],
                "Kab. Pangkep": ["Pangkajene", "Bungoro", "Labakkang", "Ma'rang", "Segeri", "Minasatene", "Mandalle", "Tondong Tallasa", "Balocci", "Liukang Tupabbiring", "Liukang Tupabbiring Utara", "Liukang Tangaya", "Liukang Kalmas"],
                "Kab. Bone": ["Tanete Riattang", "Tanete Riattang Barat", "Tanete Riattang Timur", "Cina", "Barebbo", "Sibulue", "Mare", "Tonra", "Patimpeng", "Libureng"]
            },
            "Sulawesi Tenggara": {
                "Kota Kendari": ["Kendari", "Kendari Barat", "Mandonga", "Puuwatu", "Kadia", "Wua-Wua", "Baruga", "Poasia", "Abeli", "Kambu", "Nambo"],
                "Kab. Konawe": ["Unaaha", "Wawotobi", "Wonggeduku", "Pondidaha", "Sampara", "Lambuya", "Puriala", "Tongauna", "Besulutu", "Bondoala"]
            },
            "Gorontalo": {
                "Kota Gorontalo": ["Kota Barat", "Kota Selatan", "Kota Tengah", "Kota Timur", "Kota Utara", "Dungingi", "Hulonthalangi", "Dumbo Raya", "Sipatana"],
                "Kab. Gorontalo": ["Limboto", "Limboto Barat", "Telaga", "Telaga Biru", "Tilango", "Batudaa", "Batudaa Pantai", "Biluhu", "Bongomeme", "Tabongo"]
            },
            "Sulawesi Barat": {
                "Kab. Mamuju": ["Mamuju", "Simboro", "Kepulauan Bala Balakang", "Kalukku", "Papalang", "Sampaga", "Tommo", "Kalumpang", "Bonehau", "Tapalang", "Tapalang Barat"],
                "Kab. Polewali Mandar": ["Polewali", "Binuang", "Anreapi", "Matakali", "Wonomulyo", "Mapilli", "Tapango", "Campalagian", "Luyo", "Limboro", "Tubbi Taramanu", "Alu", "Balanipa", "Tinambung", "Matangnga", "Bulo"]
            },
            "Maluku": {
                "Kota Ambon": ["Nusaniwe", "Sirimau", "Teluk Ambon", "Baguala", "Leitimur Selatan"],
                "Kab. Maluku Tengah": ["Masohi", "Amahai", "Tehoru", "Telutih", "Seram Utara", "Seram Utara Barat", "Seram Utara Timur Kobi", "Seram Utara Timur Seti", "Banda", "Saparua", "Saparua Timur", "Nusalaut", "Pulau Haruku", "Leihitu", "Leihitu Barat", "Salahutu", "Teon Nila Serua"]
            },
            "Maluku Utara": {
                "Kota Ternate": ["Ternate Selatan", "Ternate Tengah", "Ternate Utara", "Pulau Ternate", "Moti", "Pulau Batang Dua", "Pulau Hiri"],
                "Kota Tidore Kepulauan": ["Tidore", "Tidore Selatan", "Tidore Timur", "Tidore Utara", "Oba", "Oba Selatan", "Oba Tengah", "Oba Utara"],
                "Kab. Halmahera Utara": ["Tobelo", "Tobelo Barat", "Tobelo Selatan", "Tobelo Tengah", "Tobelo Timur", "Tobelo Utara", "Galela", "Galela Barat", "Galela Selatan", "Galela Utara"]
            },
            "Papua": {
                "Kota Jayapura": ["Jayapura Utara", "Jayapura Selatan", "Abepura", "Heram", "Muara Tami"],
                "Kab. Jayapura": ["Sentani", "Sentani Barat", "Sentani Timur", "Waibu", "Nimbokrang", "Nimboran", "Kemtuk", "Kemtuk Gresi", "Gresi Selatan", "Yapsi", "Ebungfau", "Raveni Rara", "Yokari", "Demta", "Depapre", "Kaureh", "Unurum Guay", "Airu"]
            },
            "Papua Barat": {
                "Kota Sorong": ["Sorong", "Sorong Barat", "Sorong Kepulauan", "Sorong Timur", "Sorong Utara", "Sorong Manoi", "Malaimsimsa", "Klaurung", "Maladum Mes", "Mayamuk"],
                "Kab. Sorong": ["Aimas", "Salawati", "Salawati Utara", "Mayamuk", "Makbon", "Klayili", "Beraur", "Klamono", "Mariat", "Segun"]
            },
            "Papua Selatan": {
                "Kab. Merauke": ["Merauke", "Sota", "Semangga", "Tanah Miring", "Jagebob", "Kurik", "Malind", "Animha", "Naukenjerai", "Kimaam", "Tubang", "Ulilin", "Waan", "Okaba", "Ngguti", "Kaptel", "Muting", "Elikobel", "Ilwayab", "Tabonji"]
            },
            "Papua Tengah": {
                "Kab. Mimika": ["Mimika Baru", "Mimika Timur", "Mimika Timur Jauh", "Mimika Timur Tengah", "Mimika Tengah", "Kuala Kencana", "Tembagapura", "Agimuga", "Jita", "Jila", "Kwamki Narama", "Iwaka", "Hoya", "Amar", "Alama", "Wania", "Aradide"]
            },
            "Papua Pegunungan": {
                "Kab. Jayawijaya": ["Wamena", "Asolokobal", "Assologaima", "Bolakme", "Bugi", "Hubikosi", "Ibele", "Itlay Hisage", "Koragi", "Kurulu", "Libarek", "Makki", "Maima", "Muliama", "Musatfak", "Napua", "Pelebaga", "Pisugi", "Piramid", "Silo Karno Doga"]
            },
            "Papua Barat Daya": {
                "Kab. Sorong Selatan": ["Teminabuan", "Seremuk", "Sawiat", "Kokoda", "Kokoda Utara", "Kais", "Metamani", "Inanwatan", "Wayer", "Moswaren", "Konda", "Fokour", "Saifi"]
            }
        };

        // Populate Provinsi dropdown
        function populateProvinsi() {
            const provinsiSelect = document.getElementById('provinsi');
            provinsiSelect.innerHTML = '<option value="">Pilih Provinsi</option>';
            Object.keys(dataWilayah).forEach(prov => {
                provinsiSelect.innerHTML += `<option value="${prov}">${prov}</option>`;
            });
        }

        // Update Kabupaten berdasarkan Provinsi
        function updateKabupaten() {
            const provinsi = document.getElementById('provinsi').value;
            const kabupatenSelect = document.getElementById('kabupaten');
            const kecamatanSelect = document.getElementById('kecamatan');

            kabupatenSelect.innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
            kecamatanSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';

            if (provinsi && dataWilayah[provinsi]) {
                Object.keys(dataWilayah[provinsi]).forEach(kab => {
                    kabupatenSelect.innerHTML += `<option value="${kab}">${kab}</option>`;
                });
            }
        }

        // Update Kecamatan berdasarkan Kabupaten
        function updateKecamatan() {
            const provinsi = document.getElementById('provinsi').value;
            const kabupaten = document.getElementById('kabupaten').value;
            const kecamatanSelect = document.getElementById('kecamatan');

            kecamatanSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';

            if (provinsi && kabupaten && dataWilayah[provinsi][kabupaten]) {
                dataWilayah[provinsi][kabupaten].forEach(kec => {
                    kecamatanSelect.innerHTML += `<option value="${kec}">${kec}</option>`;
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const canvasCustomer = document.getElementById('signatureCustomer');
            const canvasSPV = document.getElementById('signatureSPV');
            const canvasManager = document.getElementById('signatureManager');

            signaturePadCustomer = new SignaturePad(canvasCustomer);
            signaturePadSPV = new SignaturePad(canvasSPV);
            signaturePadManager = new SignaturePad(canvasManager);

            // Kunci SPV dan Manager - hanya bisa TTD dari arsip
            signaturePadSPV.off();
            signaturePadManager.off();

            document.getElementById('tanggal').valueAsDate = new Date();
            document.getElementById('noFO').value = generateNoFO();

            // Populate dropdown wilayah
            populateProvinsi();

            // Load logo untuk PDF
            loadLogo();

            // Load master data from Google Sheets
            loadMasterData();

            addOrderItem();
        });
        
        // ========================================
        // SKU SEARCH & AUTO-FILL (Same as before)
        // ========================================
        
        function setupSKUSearch(itemId) {
            const input = document.querySelector(`#item-${itemId} .item-sku-input`);
            const suggestionsDiv = document.querySelector(`#item-${itemId} .sku-suggestions`);
            
            input.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                
                if (searchTerm.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                const matches = masterDataSKU.filter(item =>
                    item.sku.toLowerCase().includes(searchTerm) ||
                    item.nama.toLowerCase().includes(searchTerm) ||
                    item.series.toLowerCase().includes(searchTerm) ||
                    item.gender.toLowerCase().includes(searchTerm)
                );
                
                if (matches.length > 0) {
                    suggestionsDiv.innerHTML = matches.map(item => {
                        const stockClass = item.stock > 20 ? 'stock-available' : item.stock > 10 ? 'stock-low' : 'stock-out';
                        return `
                            <div class="sku-suggestion-item" onclick="selectSKU(${itemId}, '${item.sku}')">
                                <div class="sku-code">${item.sku} <span class="stock-indicator ${stockClass}">Stock: ${item.stock}</span></div>
                                <div class="sku-details">${item.nama} | ${item.gender} | ${item.series} | Rp ${item.harga.toLocaleString('id-ID')}</div>
                            </div>
                        `;
                    }).join('');
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.innerHTML = '<div class="sku-suggestion-item">Tidak ada hasil</div>';
                    suggestionsDiv.style.display = 'block';
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.sku-search-container')) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }
        
        function selectSKU(itemId, sku) {
            const product = masterDataSKU.find(item => item.sku === sku);

            if (product) {
                const item = document.getElementById(`item-${itemId}`);

                // Hitung diskon berdasarkan gender
                // BABY = 30%, lainnya (LADIES, MEN) = 40%
                const discountPercent = product.gender.toUpperCase() === 'BABY' ? 30 : 40;
                const hargaNormal = product.harga;
                const hargaDiskon = Math.round(hargaNormal * (100 - discountPercent) / 100);

                item.querySelector('.item-sku-input').value = product.sku;
                item.querySelector('.item-name').value = product.nama;
                item.querySelector('.item-series').value = product.series;
                item.querySelector('.item-gender').value = product.gender;
                item.querySelector('.item-price-normal').value = `Rp ${hargaNormal.toLocaleString('id-ID')}`;
                item.querySelector('.item-discount').value = `${discountPercent}%`;
                item.querySelector('.item-price').value = hargaDiskon;
                item.querySelector('.item-stock-display').textContent = `Stock: ${product.stock} | MOQ: ${product.moq}`;
                item.querySelector('.sku-suggestions').style.display = 'none';

                // Tampilkan foto produk
                const imgElement = item.querySelector('.item-image');
                const placeholderElement = item.querySelector('.item-image-placeholder');
                const containerElement = item.querySelector('.item-image-container');

                if (product.imageUrl) {
                    imgElement.src = product.imageUrl;
                    imgElement.alt = product.nama;
                    imgElement.style.display = 'block';
                    placeholderElement.style.display = 'none';
                    containerElement.style.borderStyle = 'solid';
                    containerElement.style.borderColor = '#2E75B5';
                } else {
                    imgElement.style.display = 'none';
                    placeholderElement.style.display = 'block';
                    containerElement.style.borderStyle = 'dashed';
                    containerElement.style.borderColor = '#ddd';
                }

                item.querySelector('.item-qty').focus();
            }
        }
        
        // Rest of the functions (addOrderItem, removeItem, calculateTotal, signatures, generatePDF)
        // Same as Form_Order_Master_Data.html - included in full file
        
        function addOrderItem() {
            itemCounter++;
            const itemsContainer = document.getElementById('orderItems');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'order-item';
            itemDiv.id = `item-${itemCounter}`;
            itemDiv.innerHTML = `
                <h4>Item #${itemCounter}</h4>
                ${itemCounter > 1 ? `<button type="button" class="btn btn-remove" onclick="removeItem(${itemCounter})">‚úï Hapus</button>` : ''}
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <!-- Image Preview (Click to Zoom) -->
                    <div class="item-image-container" onclick="handleImageClick(${itemCounter})" style="flex-shrink: 0; width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #f9f9f9; overflow: hidden; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';" title="Klik untuk memperbesar">
                        <img class="item-image" src="" alt="" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
                        <span class="item-image-placeholder" style="color: #ccc; font-size: 12px; text-align: center;">üì∑<br>No Image</span>
                    </div>
                    <!-- Form Fields -->
                    <div style="flex-grow: 1;">
                        <div class="sku-search-container">
                            <label>üîç Cari SKU / Nama Produk *</label>
                            <input type="text" class="item-sku-input" placeholder="Ketik SKU atau nama produk..." autocomplete="off">
                            <div class="sku-suggestions"></div>
                        </div>
                        <!-- Row 1: Nama Produk & Series & Gender -->
                        <div class="item-row" style="grid-template-columns: 3fr 1fr 1fr; margin-bottom: 8px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Nama Produk *</label>
                                <input type="text" class="item-name" placeholder="Auto-fill dari SKU" readonly style="font-weight: 600;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Series</label>
                                <input type="text" class="item-series" placeholder="Auto-fill" readonly style="text-align: center;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Gender</label>
                                <input type="text" class="item-gender" placeholder="Auto-fill" readonly style="text-align: center;">
                            </div>
                        </div>
                        <!-- Row 2: Harga & Qty -->
                        <div class="item-row" style="grid-template-columns: 1.2fr 0.8fr 1.2fr 1fr; margin-bottom: 8px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Harga Normal</label>
                                <input type="text" class="item-price-normal" placeholder="Auto-fill" readonly style="text-decoration: line-through; color: #999; text-align: right;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Diskon</label>
                                <input type="text" class="item-discount" placeholder="Auto-fill" readonly style="color: #e74c3c; font-weight: bold; text-align: center;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Harga Diskon</label>
                                <input type="number" class="item-price" placeholder="Auto-fill" readonly style="color: #27ae60; font-weight: bold; text-align: right;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Qty (Box) *</label>
                                <input type="number" class="item-qty" placeholder="0" min="1" onchange="calculateTotal()" style="text-align: center; font-weight: bold;">
                            </div>
                        </div>
                        <div class="form-group">
                            <small class="item-stock-display" style="color: #666; font-style: italic;">Pilih SKU untuk melihat stock & MOQ</small>
                        </div>
                    </div>
                </div>
            `;
            itemsContainer.appendChild(itemDiv);
            setupSKUSearch(itemCounter);
            calculateTotal();
        }
        
        function removeItem(id) {
            const item = document.getElementById(`item-${id}`);
            if (item) {
                item.remove();
                calculateTotal();
            }
        }
        
        function calculateTotal() {
            let totalItems = 0, totalQty = 0, totalAmount = 0;
            document.querySelectorAll('.order-item').forEach(item => {
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                const qty = parseInt(item.querySelector('.item-qty').value) || 0;
                const sku = item.querySelector('.item-sku-input').value;
                if (sku && qty > 0) {
                    totalItems++;
                    totalQty += qty;
                    totalAmount += price * qty;
                }
            });
            document.getElementById('totalItems').textContent = `${totalItems} Items`;
            document.getElementById('totalQty').textContent = `${totalQty} Box`;
            document.getElementById('totalAmount').textContent = `Rp ${totalAmount.toLocaleString('id-ID')}`;
        }
        
        function clearSignature(type) {
            if (type === 'customer') signaturePadCustomer.clear();
            else if (type === 'spv') signaturePadSPV.clear();
            else if (type === 'manager') signaturePadManager.clear();
        }
        
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========================================
        // IMAGE ZOOM MODAL
        // ========================================
        function openImageZoom(imageUrl, productName) {
            if (!imageUrl) return;

            const modal = document.getElementById('imageZoomModal');
            const zoomImg = document.getElementById('zoomImage');
            const caption = document.getElementById('zoomImageCaption');

            // Gunakan ukuran besar untuk zoom (w800 instead of w200)
            let largeImageUrl = imageUrl.replace('sz=w200', 'sz=w800');

            zoomImg.src = largeImageUrl;
            caption.textContent = productName || '';
            modal.style.display = 'flex';

            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function closeImageZoom(event) {
            // Jika klik dari event, hanya tutup jika klik di luar gambar
            if (event && event.target.id !== 'imageZoomModal') return;

            const modal = document.getElementById('imageZoomModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function handleImageClick(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            if (!item) return;

            const imgElement = item.querySelector('.item-image');
            const productName = item.querySelector('.item-name').value;

            if (imgElement && imgElement.src && imgElement.style.display !== 'none') {
                openImageZoom(imgElement.src, productName);
            }
        }

        // Keyboard support for image zoom (ESC to close)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('imageZoomModal');
                if (modal && modal.style.display === 'flex') {
                    closeImageZoom();
                }
            }
        });

        // ========================================
        // SAVE ORDER (Simpan ke Arsip)
        // ========================================
        function saveOrder() {
            const form = document.getElementById('orderForm');
            if (!form.checkValidity()) {
                showAlert('‚ùå Mohon lengkapi semua field yang wajib diisi (*)', 'error');
                form.reportValidity();
                return;
            }
            const hasValidItem = Array.from(document.querySelectorAll('.order-item')).some(item => {
                const sku = item.querySelector('.item-sku-input').value;
                const qty = parseInt(item.querySelector('.item-qty').value) || 0;
                return sku && qty > 0;
            });
            if (!hasValidItem) {
                showAlert('‚ùå Mohon tambahkan minimal 1 item dengan SKU dan Qty', 'error');
                return;
            }
            if (signaturePadCustomer.isEmpty()) {
                showAlert('‚ùå Mohon lengkapi tanda tangan Customer', 'error');
                return;
            }

            // Get form data
            const tanggal = document.getElementById('tanggal').value;
            const noFO = document.getElementById('noFO').value;
            const namaToko = document.getElementById('namaToko').value;
            const alamat = document.getElementById('alamat').value;
            const kecamatan = document.getElementById('kecamatan').value;
            const kabupaten = document.getElementById('kabupaten').value;
            const provinsi = document.getElementById('provinsi').value;
            const hp = document.getElementById('hp').value;
            const alamatLengkap = `${alamat}, Kec. ${kecamatan}, ${kabupaten}, ${provinsi}`;

            // Get order items (dengan Price)
            const orderItems = [];
            let totalQty = 0, totalAmount = 0, itemNumber = 0;
            document.querySelectorAll('.order-item').forEach(item => {
                const sku = item.querySelector('.item-sku-input').value;
                const name = item.querySelector('.item-name').value;
                const series = item.querySelector('.item-series').value;
                const gender = item.querySelector('.item-gender').value;
                const discount = item.querySelector('.item-discount').value;
                const priceNormal = item.querySelector('.item-price-normal').value || '-'; // Price (harga normal)
                const price = parseFloat(item.querySelector('.item-price').value) || 0; // Harga setelah diskon
                const qty = parseInt(item.querySelector('.item-qty').value) || 0;
                if (sku && qty > 0) {
                    itemNumber++;
                    const subtotal = price * qty;
                    // Format: No, SKU, Nama, Gender, Price, Diskon, Harga Diskon, Qty, Subtotal
                    orderItems.push([
                        itemNumber, sku, name, gender, priceNormal, discount,
                        `Rp ${price.toLocaleString('id-ID')}`, qty,
                        `Rp ${subtotal.toLocaleString('id-ID')}`
                    ]);
                    totalQty += qty;
                    totalAmount += subtotal;
                }
            });

            // Simpan ke arsip
            saveToArchive({
                noFO: noFO,
                tanggal: tanggal,
                customer: namaToko,
                alamat: alamatLengkap,
                hp: hp,
                orderItems: orderItems,
                totalItems: itemNumber,
                totalQty: totalQty,
                totalAmount: totalAmount,
                signedCustomer: true,
                signedSPV: false,
                signedManager: false,
                sigCustomer: signaturePadCustomer.toDataURL(),
                sigSPV: null,
                sigManager: null,
                nameCustomer: document.getElementById('customerSignName').value || '',
                nameSPV: 'Ni Luh Kade Yuliani',
                nameManager: 'Budy',
                createdAt: new Date().toISOString()
            });

            showAlert(`‚úÖ Order ${noFO} berhasil disimpan! Silakan lanjutkan TTD SPV & Manager di Arsip Order.`, 'success');

            // Reset form untuk order baru
            resetForm();
        }

        function resetForm() {
            // Generate nomor FO baru
            document.getElementById('noFO').value = generateNoFO();

            // Reset customer info
            document.getElementById('namaToko').value = '';
            document.getElementById('alamat').value = '';
            document.getElementById('provinsi').selectedIndex = 0;
            document.getElementById('kabupaten').innerHTML = '<option value="">-- Pilih Kabupaten --</option>';
            document.getElementById('kecamatan').innerHTML = '<option value="">-- Pilih Kecamatan --</option>';
            document.getElementById('hp').value = '';

            // Reset order items
            document.getElementById('orderItems').innerHTML = '';
            addOrderItem();

            // Reset signature
            signaturePadCustomer.clear();
            document.getElementById('customerSignName').value = '';

            // Reset totals
            document.getElementById('totalQty').textContent = '0 Box';
            document.getElementById('totalAmount').textContent = 'Rp 0';
        }

        // ========================================
        // GENERATE PDF (dari Arsip saja)
        // ========================================
        function generatePDF() {
            const form = document.getElementById('orderForm');
            if (!form.checkValidity()) {
                showAlert('‚ùå Mohon lengkapi semua field yang wajib diisi (*)', 'error');
                form.reportValidity();
                return;
            }
            const hasValidItem = Array.from(document.querySelectorAll('.order-item')).some(item => {
                const sku = item.querySelector('.item-sku-input').value;
                const qty = parseInt(item.querySelector('.item-qty').value) || 0;
                return sku && qty > 0;
            });
            if (!hasValidItem) {
                showAlert('‚ùå Mohon tambahkan minimal 1 item dengan SKU dan Qty', 'error');
                return;
            }
            if (signaturePadCustomer.isEmpty()) {
                showAlert('‚ùå Mohon lengkapi tanda tangan Customer', 'error');
                return;
            }

            // Get form data
            const tanggal = document.getElementById('tanggal').value;
            const noFO = document.getElementById('noFO').value;
            const namaToko = document.getElementById('namaToko').value;
            const alamat = document.getElementById('alamat').value;
            const kecamatan = document.getElementById('kecamatan').value;
            const kabupaten = document.getElementById('kabupaten').value;
            const provinsi = document.getElementById('provinsi').value;
            const hp = document.getElementById('hp').value;
            const alamatLengkap = `${alamat}, Kec. ${kecamatan}, ${kabupaten}, ${provinsi}`;
            
            // Get order items
            const orderItems = [];
            let totalQty = 0, totalAmount = 0, itemNumber = 0;
            document.querySelectorAll('.order-item').forEach(item => {
                const sku = item.querySelector('.item-sku-input').value;
                const name = item.querySelector('.item-name').value;
                const series = item.querySelector('.item-series').value;
                const gender = item.querySelector('.item-gender').value;
                const discount = item.querySelector('.item-discount').value;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                const qty = parseInt(item.querySelector('.item-qty').value) || 0;
                if (sku && qty > 0) {
                    itemNumber++;
                    const subtotal = price * qty;
                    orderItems.push([
                        itemNumber, sku, name, gender, discount,
                        `Rp ${price.toLocaleString('id-ID')}`, qty,
                        `Rp ${subtotal.toLocaleString('id-ID')}`
                    ]);
                    totalQty += qty;
                    totalAmount += subtotal;
                }
            });
            
            // Create PDF (same as before)
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Header dengan logo di kiri, text di kanan
            if (logoBase64) {
                // Logo di kiri
                doc.addImage(logoBase64, 'PNG', 15, 8, 35, 25);
                // Text di kanan logo
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('CV. UNTUNG BESAR BERSAMA', 55, 15);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Kahuripan Park 1-09, Desa Sumput, Kec. Sidoarjo', 55, 21);
                doc.text('Kab. Sidoarjo, Jawa Timur', 55, 26);
                doc.text('Email: untungbesarbersama@gmail.com', 55, 31);
            } else {
                // Fallback ke text header jika logo tidak tersedia
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('CV. UNTUNG BESAR BERSAMA', 105, 15, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Kahuripan Park 1-09, Desa Sumput, Kec. Sidoarjo, Kab Sidoarjo, Jawa Timur', 105, 21, { align: 'center' });
                doc.text('Email: untungbesarbersama@gmail.com', 105, 26, { align: 'center' });
            }

            // Garis pemisah
            doc.setLineWidth(0.5);
            doc.line(15, 36, 195, 36);

            // Judul Form
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('FORM ORDER WHOLESALE', 105, 44, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0); // Hitam
            doc.text(`Tanggal: ${new Date(tanggal).toLocaleDateString('id-ID')}`, 15, 52);
            doc.text(`No. Form: ${noFO}`, 120, 52);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('INFORMASI CUSTOMER', 15, 62);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Nama Customer: ${namaToko}`, 15, 68);
            doc.text(`Alamat: ${alamatLengkap}`, 15, 74, { maxWidth: 180 });
            doc.text(`No. HP: ${hp}`, 15, 84);

            doc.autoTable({
                startY: 92,
                head: [['No', 'SKU', 'Nama Produk', 'Gender', 'Diskon', 'Harga Diskon', 'Qty (Box)', 'Subtotal']],
                body: orderItems,
                foot: [[
                    { content: 'TOTAL ORDER', colSpan: 6, styles: { halign: 'center', fontStyle: 'bold' } },
                    { content: `${totalQty}`, styles: { fontStyle: 'bold', halign: 'center' } },
                    { content: `Rp ${totalAmount.toLocaleString('id-ID')}`, styles: { fontStyle: 'bold', halign: 'right' } }
                ]],
                theme: 'grid',
                headStyles: { fillColor: [68, 114, 196], textColor: 255, fontStyle: 'bold', halign: 'center' },
                footStyles: { fillColor: [255, 255, 204], textColor: 0, fontStyle: 'bold' },
                styles: { fontSize: 8, cellPadding: 2, lineColor: [0, 0, 0], lineWidth: 0.3 },
                tableLineColor: [0, 0, 0],
                tableLineWidth: 0.3,
                columnStyles: {
                    0: { cellWidth: 8, halign: 'center' },
                    1: { cellWidth: 22, halign: 'center' },
                    2: { cellWidth: 45 },
                    3: { cellWidth: 15, halign: 'center' },
                    4: { cellWidth: 15, halign: 'center', textColor: [0, 0, 0] },
                    5: { cellWidth: 25, halign: 'center', textColor: [0, 0, 0] },
                    6: { cellWidth: 12, halign: 'center' },
                    7: { cellWidth: 25, halign: 'center' }
                }
            });
            
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('CATATAN:', 15, finalY);
            doc.setFont('helvetica', 'normal');
            const notes = [
                '1. Harga sudah termasuk diskon wholesale (40%-50% untuk offline store, 30% untuk baby products)',
                '2. Harga BELUM termasuk ongkos kirim',
                '3. Stock terbatas dan dapat berubah sewaktu-waktu',
                '4. Form Order ini valid selama 1x24 jam sejak diterbitkan'
            ];
            let noteY = finalY + 5;
            notes.forEach(note => {
                doc.text(note, 15, noteY, { maxWidth: 180 });
                noteY += 5;
            });
            
            const sigY = noteY + 10;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('Customer:', 25, sigY);
            doc.text('SPV Wholesale:', 85, sigY);
            doc.text('Branch Manager:', 145, sigY);

            const sigCustomer = signaturePadCustomer.toDataURL();
            doc.addImage(sigCustomer, 'PNG', 15, sigY + 3, 45, 18);

            // SPV Wholesale signature - selalu belum TTD saat generate pertama
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(7);
            doc.text('(Belum ditandatangani)', 97, sigY + 12, { align: 'center' });

            // Branch Manager signature - selalu belum TTD saat generate pertama
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(7);
            doc.text('(Belum ditandatangani)', 157, sigY + 12, { align: 'center' });

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const customerSignName = document.getElementById('customerSignName').value || namaToko;
            doc.text(`(${customerSignName})`, 37, sigY + 25, { align: 'center' });
            doc.text('(Ni Luh Kade Yuliani)', 97, sigY + 25, { align: 'center' });
            doc.text('(Budy)', 157, sigY + 25, { align: 'center' });
            
            const filename = `FO_${noFO}_${namaToko.replace(/\s+/g, '_')}_${itemNumber}items.pdf`;
            doc.save(filename);

            // Simpan ke arsip dengan data lengkap
            // SPV dan Manager selalu belum TTD saat buat order baru (TTD dari arsip)
            saveToArchive({
                noFO: noFO,
                tanggal: tanggal,
                customer: namaToko,
                alamat: alamatLengkap,
                hp: hp,
                orderItems: orderItems, // Simpan items untuk regenerate PDF
                totalItems: itemNumber,
                totalQty: totalQty,
                totalAmount: totalAmount,
                signedCustomer: true,
                signedSPV: false, // TTD dari arsip
                signedManager: false, // TTD dari arsip
                // Simpan signature sebagai base64 untuk regenerate PDF
                sigCustomer: signaturePadCustomer.toDataURL(),
                sigSPV: null,
                sigManager: null,
                nameCustomer: document.getElementById('customerSignName').value || namaToko,
                nameSPV: 'Ni Luh Kade Yuliani',
                nameManager: 'Budy',
                createdAt: new Date().toISOString()
            });

            showAlert(`‚úÖ PDF berhasil dibuat: ${filename}`, 'success');
        }

        // ========================================
        // ARCHIVE FUNCTIONS
        // ========================================

        function saveToArchive(orderData) {
            let archive = JSON.parse(localStorage.getItem('fo_archive') || '[]');
            // Update jika sudah ada, atau tambah baru
            const existingIndex = archive.findIndex(o => o.noFO === orderData.noFO);
            if (existingIndex >= 0) {
                archive[existingIndex] = orderData;
            } else {
                archive.unshift(orderData);
            }
            localStorage.setItem('fo_archive', JSON.stringify(archive));
        }

        let currentFilter = 'all';

        function showArchive() {
            document.getElementById('archiveModal').style.display = 'block';
            filterArchive(currentFilter);
        }

        function filterArchive(filter) {
            currentFilter = filter;
            const archive = JSON.parse(localStorage.getItem('fo_archive') || '[]');
            const archiveList = document.getElementById('archiveList');
            const filterInfo = document.getElementById('filterInfo');

            // Update button styles
            document.getElementById('filterAll').style.background = filter === 'all' ? '#3498db' : '#e8e8e8';
            document.getElementById('filterAll').style.color = filter === 'all' ? 'white' : '#333';
            document.getElementById('filterAll').style.borderColor = filter === 'all' ? '#3498db' : '#e8e8e8';
            document.getElementById('filterAll').style.fontWeight = filter === 'all' ? 'bold' : 'normal';

            document.getElementById('filterPending').style.background = filter === 'pending' ? '#f39c12' : '#fff3cd';
            document.getElementById('filterPending').style.color = filter === 'pending' ? 'white' : '#856404';
            document.getElementById('filterPending').style.borderColor = filter === 'pending' ? '#f39c12' : '#fff3cd';
            document.getElementById('filterPending').style.fontWeight = filter === 'pending' ? 'bold' : 'normal';

            document.getElementById('filterComplete').style.background = filter === 'complete' ? '#27ae60' : '#d4edda';
            document.getElementById('filterComplete').style.color = filter === 'complete' ? 'white' : '#155724';
            document.getElementById('filterComplete').style.borderColor = filter === 'complete' ? '#27ae60' : '#d4edda';
            document.getElementById('filterComplete').style.fontWeight = filter === 'complete' ? 'bold' : 'normal';

            // Filter archive
            let filteredArchive = archive;
            if (filter === 'pending') {
                filteredArchive = archive.filter(o => !o.signedSPV || !o.signedManager);
            } else if (filter === 'complete') {
                filteredArchive = archive.filter(o => o.signedSPV && o.signedManager);
            }

            // Count for info
            const pendingCount = archive.filter(o => !o.signedSPV || !o.signedManager).length;
            const completeCount = archive.filter(o => o.signedSPV && o.signedManager).length;

            // Show filter info
            if (filter === 'all') {
                filterInfo.innerHTML = `Menampilkan <strong>${archive.length}</strong> order (${pendingCount} menunggu, ${completeCount} lengkap)`;
            } else if (filter === 'pending') {
                filterInfo.innerHTML = `Menampilkan <strong>${filteredArchive.length}</strong> order yang menunggu TTD`;
            } else {
                filterInfo.innerHTML = `Menampilkan <strong>${filteredArchive.length}</strong> order yang sudah lengkap`;
            }

            if (filteredArchive.length === 0) {
                if (archive.length === 0) {
                    archiveList.innerHTML = '<p style="text-align: center; color: #666; padding: 30px;">Belum ada arsip order</p>';
                } else {
                    archiveList.innerHTML = `<p style="text-align: center; color: #666; padding: 30px;">Tidak ada order dengan status "${filter === 'pending' ? 'Menunggu TTD' : 'Lengkap'}"</p>`;
                }
            } else {
                archiveList.innerHTML = filteredArchive.map(order => {
                    const statusColor = (order.signedSPV && order.signedManager) ? '#d4edda' : '#fff3cd';
                    const statusIcon = (order.signedSPV && order.signedManager) ? 'üü¢' : 'üü°';
                    const statusText = (order.signedSPV && order.signedManager) ? 'Lengkap' : 'Menunggu TTD';

                    // Tentukan aksi yang tersedia
                    let actionButton = '';
                    if (!order.signedSPV) {
                        actionButton = `<button onclick="openOrderDetail('${order.noFO}')" style="background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-top: 8px;">‚úçÔ∏è TTD SPV</button>`;
                    } else if (!order.signedManager) {
                        actionButton = `<button onclick="openOrderDetail('${order.noFO}')" style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-top: 8px;">‚úçÔ∏è TTD Manager</button>`;
                    } else {
                        actionButton = `<button onclick="openOrderDetail('${order.noFO}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-top: 8px;">üì• Generate PDF</button>`;
                    }

                        // Tentukan apakah tombol hapus ditampilkan
                    // Customer tidak boleh hapus jika sudah di-TTD SPV/Manager
                    const isCustomer = currentUser && currentUser.role === 'customer';
                    const isSignedBySPVOrManager = order.signedSPV || order.signedManager;
                    const canDelete = !isCustomer || !isSignedBySPVOrManager;

                    const deleteButton = canDelete
                        ? `<button onclick="event.stopPropagation(); deleteOrder('${order.noFO}')" style="position: absolute; top: 8px; right: 8px; background: #e74c3c; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" title="Hapus Order">‚úï</button>`
                        : '';

                    return `
                        <div style="background: ${statusColor}; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${order.signedSPV && order.signedManager ? '#27ae60' : '#f39c12'}; cursor: pointer; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='scale(1.01)'" onmouseout="this.style.transform='scale(1)'">
                            ${deleteButton}
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div onclick="openOrderDetail('${order.noFO}')" style="flex: 1;">
                                    <strong style="font-size: 16px; color: #1F4E78;">${order.noFO}</strong>
                                    <span style="margin-left: 10px; font-size: 12px; color: #666;">${new Date(order.tanggal).toLocaleDateString('id-ID')}</span>
                                    <br>
                                    <span style="color: #333;">${order.customer}</span>
                                    <br>
                                    <small style="color: #666;">${order.totalItems} items | ${order.totalQty} Box | Rp ${order.totalAmount.toLocaleString('id-ID')}</small>
                                </div>
                                <div style="text-align: right; margin-right: 20px;">
                                    <span style="font-size: 12px;">${statusIcon} ${statusText}</span>
                                    <br>
                                    <small>
                                        Customer: ‚úÖ |
                                        SPV: ${order.signedSPV ? '‚úÖ' : '‚ùå'} |
                                        Manager: ${order.signedManager ? '‚úÖ' : '‚ùå'}
                                    </small>
                                    <br>
                                    ${actionButton}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function closeArchive() {
            document.getElementById('archiveModal').style.display = 'none';
        }

        function deleteOrder(noFO) {
            // Cari order untuk ditampilkan di konfirmasi
            const archive = JSON.parse(localStorage.getItem('fo_archive') || '[]');
            const order = archive.find(o => o.noFO === noFO);

            if (!order) {
                alert('Order tidak ditemukan!');
                return;
            }

            // Customer tidak boleh hapus jika sudah di-TTD SPV atau Manager
            if (currentUser && currentUser.role === 'customer') {
                if (order.signedSPV || order.signedManager) {
                    alert('Anda tidak dapat menghapus order ini karena sudah ditandatangani oleh SPV/Manager.\n\nHubungi SPV atau Admin untuk bantuan.');
                    return;
                }
            }

            // Konfirmasi hapus
            const confirmMessage = `Yakin ingin menghapus order ini?\n\n` +
                `No. FO: ${order.noFO}\n` +
                `Customer: ${order.customer}\n` +
                `Total: Rp ${order.totalAmount.toLocaleString('id-ID')}\n\n` +
                `Order akan dipindahkan ke Sampah.`;

            if (confirm(confirmMessage)) {
                // Pindahkan ke trash
                let trash = JSON.parse(localStorage.getItem('fo_trash') || '[]');
                order.deletedAt = new Date().toISOString();
                trash.unshift(order);
                localStorage.setItem('fo_trash', JSON.stringify(trash));

                // Hapus dari archive
                const updatedArchive = archive.filter(o => o.noFO !== noFO);
                localStorage.setItem('fo_archive', JSON.stringify(updatedArchive));

                // Refresh arsip
                filterArchive(currentFilter);

                alert('Order dipindahkan ke Sampah!');
            }
        }

        // ========================================
        // TRASH FUNCTIONS
        // ========================================

        function openTrash() {
            const trash = JSON.parse(localStorage.getItem('fo_trash') || '[]');
            const trashList = document.getElementById('trashList');
            const trashInfo = document.getElementById('trashInfo');

            trashInfo.textContent = `${trash.length} order di sampah`;

            if (trash.length === 0) {
                trashList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Sampah kosong</p>';
            } else {
                trashList.innerHTML = trash.map(order => {
                    const deletedDate = new Date(order.deletedAt).toLocaleDateString('id-ID');
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6c757d;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #333;">${order.noFO}</div>
                                <div style="font-size: 13px; color: #666;">${order.customer} - Rp ${order.totalAmount.toLocaleString('id-ID')}</div>
                                <div style="font-size: 11px; color: #999;">Dihapus: ${deletedDate}</div>
                            </div>
                            <div>
                                <button onclick="restoreOrder('${order.noFO}')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;">‚Ü©Ô∏è Restore</button>
                                <button onclick="permanentDelete('${order.noFO}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è Hapus</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('trashModal').style.display = 'block';
        }

        function closeTrash() {
            document.getElementById('trashModal').style.display = 'none';
        }

        function restoreOrder(noFO) {
            let trash = JSON.parse(localStorage.getItem('fo_trash') || '[]');
            const order = trash.find(o => o.noFO === noFO);

            if (!order) {
                alert('Order tidak ditemukan!');
                return;
            }

            if (confirm(`Restore order ${noFO}?`)) {
                // Hapus deletedAt property
                delete order.deletedAt;

                // Pindahkan ke archive
                let archive = JSON.parse(localStorage.getItem('fo_archive') || '[]');
                archive.unshift(order);
                localStorage.setItem('fo_archive', JSON.stringify(archive));

                // Hapus dari trash
                trash = trash.filter(o => o.noFO !== noFO);
                localStorage.setItem('fo_trash', JSON.stringify(trash));

                // Refresh
                openTrash();
                filterArchive(currentFilter);

                alert('Order berhasil di-restore!');
            }
        }

        function permanentDelete(noFO) {
            if (confirm(`Hapus permanen order ${noFO}?\n\n‚ö†Ô∏è Data tidak dapat dikembalikan!`)) {
                let trash = JSON.parse(localStorage.getItem('fo_trash') || '[]');
                trash = trash.filter(o => o.noFO !== noFO);
                localStorage.setItem('fo_trash', JSON.stringify(trash));

                openTrash();
                alert('Order dihapus permanen!');
            }
        }

        function emptyTrash() {
            const trash = JSON.parse(localStorage.getItem('fo_trash') || '[]');
            if (trash.length === 0) {
                alert('Sampah sudah kosong!');
                return;
            }

            if (confirm(`Kosongkan sampah? (${trash.length} order)\n\n‚ö†Ô∏è Semua data akan dihapus permanen!`)) {
                localStorage.setItem('fo_trash', '[]');
                openTrash();
                alert('Sampah dikosongkan!');
            }
        }

        // ========================================
        // ORDER DETAIL & APPROVAL FUNCTIONS
        // ========================================

        let currentOrderNoFO = null;
        let signaturePadSPVDetail = null;
        let signaturePadManagerDetail = null;

        function openOrderDetail(noFO) {
            const archive = JSON.parse(localStorage.getItem('fo_archive') || '[]');
            const order = archive.find(o => o.noFO === noFO);

            if (!order) {
                alert('Order tidak ditemukan!');
                return;
            }

            currentOrderNoFO = noFO;

            // Isi info customer
            document.getElementById('detailNoFO').textContent = order.noFO;
            document.getElementById('detailTanggal').textContent = new Date(order.tanggal).toLocaleDateString('id-ID');
            document.getElementById('detailCustomer').textContent = order.customer;
            document.getElementById('detailAlamat').textContent = order.alamat;
            document.getElementById('detailHP').textContent = order.hp;

            // Isi tabel order items - support format lama (8 kolom) dan baru (9 kolom)
            if (order.orderItems && order.orderItems.length > 0) {
                const isNewFormat = order.orderItems[0].length === 9;

                let tableHTML;
                if (isNewFormat) {
                    // Format baru: No, SKU, Nama, Gender, Price, Diskon, Harga Diskon, Qty, Subtotal
                    tableHTML = `
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <thead>
                                <tr style="background: #4472C4; color: white;">
                                    <th style="padding: 6px; border: 1px solid #ddd;">No</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">SKU</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Nama Produk</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Gender</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Price</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Diskon</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Harga Diskon</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Qty</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.orderItems.map(item => `
                                    <tr>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${item[0]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd;">${item[1]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd;">${item[2]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${item[3]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${item[4]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${item[5]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${item[6]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${item[7]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${item[8]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    // Format lama: No, SKU, Nama, Gender, Diskon, Harga, Qty, Subtotal
                    tableHTML = `
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <thead>
                                <tr style="background: #4472C4; color: white;">
                                    <th style="padding: 6px; border: 1px solid #ddd;">No</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">SKU</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Nama Produk</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Gender</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Diskon</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Harga</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Qty</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.orderItems.map(item => `
                                    <tr>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${item[0]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd;">${item[1]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd;">${item[2]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${item[3]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${item[4]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${item[5]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${item[6]}</td>
                                        <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${item[7]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                document.getElementById('detailOrderItems').innerHTML = tableHTML;
            } else {
                document.getElementById('detailOrderItems').innerHTML = '<p style="color: #666;">Data items tidak tersedia</p>';
            }

            document.getElementById('detailTotal').textContent = `Rp ${order.totalAmount.toLocaleString('id-ID')}`;

            // Update status approval icons
            document.getElementById('statusCustomer').textContent = order.signedCustomer ? '‚úÖ' : '‚è≥';
            document.getElementById('statusSPV').textContent = order.signedSPV ? '‚úÖ' : '‚è≥';
            document.getElementById('statusManager').textContent = order.signedManager ? '‚úÖ' : '‚è≥';

            // Tampilkan signature customer
            if (order.sigCustomer) {
                document.getElementById('imgSigCustomer').src = order.sigCustomer;
            }
            // Tampilkan nama customer
            const customerName = order.nameCustomer || order.customer;
            document.getElementById('detailNameCustomer').textContent = customerName;

            // Setup Company Selection Section
            const companySelectionSection = document.getElementById('companySelectionSection');
            const companySelector = document.getElementById('companySelector');
            const companyDisplay = document.getElementById('companyDisplay');
            const companyNote = document.getElementById('companyNote');

            // Hanya SPV dan Admin yang bisa melihat section entitas
            const loggedInUser = JSON.parse(localStorage.getItem('fo_current_user') || 'null');
            const canViewCompany = loggedInUser && (loggedInUser.role === 'spv' || loggedInUser.role === 'admin');

            if (!canViewCompany) {
                // Customer & Manager tidak pernah melihat section ini
                companySelectionSection.style.display = 'none';
            } else if (order.signedSPV && order.sigSPV) {
                // SPV/Admin: SPV sudah TTD - tampilkan company yang dipilih (read-only)
                companySelectionSection.style.display = 'block';
                companySelector.style.display = 'none';
                companyDisplay.style.display = 'block';
                companyNote.style.display = 'none';
                const companyName = order.company === 'MBB' ? 'MBB - CV. Makmur Besar Bersama' : 'UBB - CV. Untung Besar Bersama';
                document.getElementById('selectedCompanyText').textContent = companyName;
            } else {
                // SPV/Admin: SPV belum TTD - tampilkan selector
                companySelectionSection.style.display = 'block';
                companySelector.style.display = 'flex';
                companyDisplay.style.display = 'none';
                companyNote.style.display = 'block';
            }

            // Setup SPV signature
            const spvContainer = document.getElementById('spvSignatureContainer');
            const spvDisplay = document.getElementById('detailSigSPVDisplay');
            const spvInput = document.getElementById('detailSigSPVInput');

            const spvHeader = document.getElementById('spvSignatureHeader');
            if (order.signedSPV && order.sigSPV) {
                // SPV sudah TTD - tampilkan signature
                spvContainer.style.borderColor = '#333';
                spvHeader.style.background = '#333';
                spvHeader.innerHTML = '‚úì SPV Wholesale';
                document.getElementById('imgSigSPV').src = order.sigSPV;
                spvDisplay.style.display = 'block';
                spvInput.style.display = 'none';
            } else {
                // SPV belum TTD - tampilkan input
                spvContainer.style.borderColor = '#333';
                spvHeader.style.background = '#333';
                spvHeader.innerHTML = 'SPV Wholesale';
                spvDisplay.style.display = 'none';
                spvInput.style.display = 'block';

                // Initialize signature pad
                const canvasSPV = document.getElementById('signatureSPVDetail');
                if (!signaturePadSPVDetail) {
                    signaturePadSPVDetail = new SignaturePad(canvasSPV);
                } else {
                    signaturePadSPVDetail.clear();
                }
            }

            // Setup Manager signature
            const managerContainer = document.getElementById('managerSignatureContainer');
            const managerDisplay = document.getElementById('detailSigManagerDisplay');
            const managerInput = document.getElementById('detailSigManagerInput');
            const btnSignManager = document.getElementById('btnSignManager');
            const managerWaitMessage = document.getElementById('managerWaitMessage');
            const managerHeader = document.getElementById('managerSignatureHeader');

            if (order.signedManager && order.sigManager) {
                // Manager sudah TTD
                managerContainer.style.borderColor = '#333';
                managerHeader.style.background = '#333';
                managerHeader.innerHTML = '‚úì Branch Manager';
                document.getElementById('imgSigManager').src = order.sigManager;
                managerDisplay.style.display = 'block';
                managerInput.style.display = 'none';
            } else if (order.signedSPV) {
                // SPV sudah TTD, Manager bisa TTD
                managerContainer.style.borderColor = '#333';
                managerHeader.style.background = '#333';
                managerHeader.innerHTML = 'Branch Manager';
                managerDisplay.style.display = 'none';
                managerInput.style.display = 'block';
                btnSignManager.disabled = false;
                btnSignManager.style.background = '#333';
                managerWaitMessage.style.display = 'none';

                // Initialize signature pad
                const canvasManager = document.getElementById('signatureManagerDetail');
                if (!signaturePadManagerDetail) {
                    signaturePadManagerDetail = new SignaturePad(canvasManager);
                } else {
                    signaturePadManagerDetail.on(); // Enable drawing
                    signaturePadManagerDetail.clear();
                }
            } else {
                // SPV belum TTD, Manager harus menunggu
                managerContainer.style.borderColor = '#333';
                managerHeader.style.background = '#333';
                managerHeader.innerHTML = 'Branch Manager';
                managerDisplay.style.display = 'none';
                managerInput.style.display = 'block';
                btnSignManager.disabled = true;
                btnSignManager.style.background = '#999';
                managerWaitMessage.style.display = 'block';

                // Initialize signature pad (disabled state)
                const canvasManager = document.getElementById('signatureManagerDetail');
                if (!signaturePadManagerDetail) {
                    signaturePadManagerDetail = new SignaturePad(canvasManager);
                }
                signaturePadManagerDetail.off(); // Disable drawing
            }

            // Atur tombol Generate PDF - hanya aktif jika semua TTD lengkap
            const btnPDF = document.getElementById('btnRegeneratePDF');
            const pdfWarning = document.getElementById('pdfWarning');

            if (order.signedCustomer && order.signedSPV && order.signedManager) {
                // Semua TTD lengkap - aktifkan tombol
                btnPDF.disabled = false;
                btnPDF.style.background = 'linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%)';
                btnPDF.style.cursor = 'pointer';
                btnPDF.style.opacity = '1';
                btnPDF.style.boxShadow = '0 2px 8px rgba(76,175,80,0.3)';
                pdfWarning.style.display = 'none';
            } else {
                // TTD belum lengkap - disable tombol
                btnPDF.disabled = true;
                btnPDF.style.background = '#ccc';
                btnPDF.style.cursor = 'not-allowed';
                btnPDF.style.opacity = '0.6';
                btnPDF.style.boxShadow = 'none';
                pdfWarning.style.display = 'block';
            }

            // Apply role-based restrictions on signature areas
            applySignatureRestrictions(order);

            // Show modal
            document.getElementById('orderDetailModal').style.display = 'block';
        }

        function applySignatureRestrictions(order) {
            // Delete button restrictions for customer
            const btnDeleteDetail = document.getElementById('btnDeleteOrderDetail');
            if (btnDeleteDetail) {
                const isCustomer = currentUser && currentUser.role === 'customer';
                const isSignedBySPVOrManager = order.signedSPV || order.signedManager;

                if (isCustomer && isSignedBySPVOrManager) {
                    // Customer tidak boleh hapus jika sudah di-TTD
                    btnDeleteDetail.style.display = 'none';
                } else {
                    btnDeleteDetail.style.display = 'inline-block';
                }
            }

            // SPV signature restrictions
            const spvInput = document.getElementById('detailSigSPVInput');
            const btnSignSPV = document.getElementById('btnSignSPV');

            if (!order.signedSPV && spvInput && btnSignSPV) {
                if (!canSignAs('spv')) {
                    // User tidak punya akses untuk TTD SPV
                    btnSignSPV.disabled = true;
                    btnSignSPV.style.background = '#ccc';
                    btnSignSPV.title = 'Anda tidak memiliki akses untuk TTD sebagai SPV';

                    // Disable signature pad
                    if (signaturePadSPVDetail) {
                        signaturePadSPVDetail.off();
                    }

                    // Add notice
                    let notice = document.getElementById('spvNoAccessNotice');
                    if (!notice) {
                        notice = document.createElement('div');
                        notice.id = 'spvNoAccessNotice';
                        notice.style.cssText = 'background: #fff3cd; color: #856404; padding: 5px 8px; font-size: 10px; text-align: center; border-radius: 4px; margin-top: 5px;';
                        notice.textContent = 'Login sebagai SPV untuk TTD';
                        spvInput.appendChild(notice);
                    }
                } else {
                    // User punya akses
                    btnSignSPV.disabled = false;
                    btnSignSPV.style.background = '#333';
                    btnSignSPV.title = '';

                    if (signaturePadSPVDetail) {
                        signaturePadSPVDetail.on();
                    }

                    const notice = document.getElementById('spvNoAccessNotice');
                    if (notice) notice.remove();
                }
            }

            // Manager signature restrictions
            const managerInput = document.getElementById('detailSigManagerInput');
            const btnSignManager = document.getElementById('btnSignManager');
            const managerWaitMessage = document.getElementById('managerWaitMessage');

            if (!order.signedManager && managerInput && btnSignManager) {
                if (!canSignAs('manager')) {
                    // User tidak punya akses untuk TTD Manager
                    btnSignManager.disabled = true;
                    btnSignManager.style.background = '#ccc';
                    btnSignManager.title = 'Anda tidak memiliki akses untuk TTD sebagai Manager';

                    // Disable signature pad
                    if (signaturePadManagerDetail) {
                        signaturePadManagerDetail.off();
                    }

                    // Add notice (replace wait message if SPV already signed)
                    if (order.signedSPV && managerWaitMessage) {
                        managerWaitMessage.style.display = 'block';
                        managerWaitMessage.textContent = 'Login sebagai Manager untuk TTD';
                        managerWaitMessage.style.background = '#fff3cd';
                        managerWaitMessage.style.color = '#856404';
                    }
                } else if (order.signedSPV) {
                    // User punya akses dan SPV sudah TTD
                    btnSignManager.disabled = false;
                    btnSignManager.style.background = '#333';
                    btnSignManager.title = '';

                    if (signaturePadManagerDetail) {
                        signaturePadManagerDetail.on();
                    }

                    if (managerWaitMessage) {
                        managerWaitMessage.style.display = 'none';
                    }
                }
            }
        }

        function closeOrderDetail() {
            document.getElementById('orderDetailModal').style.display = 'none';
            currentOrderNoFO = null;
        }

        function deleteOrderFromDetail() {
            if (!currentOrderNoFO) return;

            const noFO = currentOrderNoFO;

            // Tutup modal detail dulu
            closeOrderDetail();

            // Panggil fungsi delete
            deleteOrder(noFO);
        }

        function clearDetailSignature(type) {
            if (type === 'spv' && signaturePadSPVDetail) {
                signaturePadSPVDetail.clear();
            } else if (type === 'manager' && signaturePadManagerDetail) {
                signaturePadManagerDetail.clear();
            }
        }

        function signAsSPV() {
            if (!currentOrderNoFO) return;

            // Check permission
            if (!canSignAs('spv')) {
                alert('Anda tidak memiliki akses untuk TTD sebagai SPV!\n\nSilakan login sebagai SPV atau Admin.');
                return;
            }

            if (!signaturePadSPVDetail || signaturePadSPVDetail.isEmpty()) {
                alert('Mohon tanda tangan terlebih dahulu!');
                return;
            }

            // Get selected company
            const selectedCompany = document.querySelector('input[name="companyChoice"]:checked').value;

            // Update archive
            let archive = JSON.parse(localStorage.getItem('fo_archive') || '[]');
            const orderIndex = archive.findIndex(o => o.noFO === currentOrderNoFO);

            if (orderIndex >= 0) {
                archive[orderIndex].signedSPV = true;
                archive[orderIndex].sigSPV = signaturePadSPVDetail.toDataURL();
                archive[orderIndex].spvSignedAt = new Date().toISOString();
                archive[orderIndex].company = selectedCompany; // Simpan pilihan perusahaan
                localStorage.setItem('fo_archive', JSON.stringify(archive));

                alert(`TTD SPV berhasil disimpan!\nPerusahaan: ${selectedCompany}`);

                // Refresh modal dan arsip
                closeOrderDetail();
                showArchive();
                openOrderDetail(currentOrderNoFO);
            }
        }

        function signAsManager() {
            if (!currentOrderNoFO) return;

            // Check permission
            if (!canSignAs('manager')) {
                alert('Anda tidak memiliki akses untuk TTD sebagai Manager!\n\nSilakan login sebagai Manager atau Admin.');
                return;
            }

            if (!signaturePadManagerDetail || signaturePadManagerDetail.isEmpty()) {
                alert('Mohon tanda tangan terlebih dahulu!');
                return;
            }

            // Update archive
            let archive = JSON.parse(localStorage.getItem('fo_archive') || '[]');
            const orderIndex = archive.findIndex(o => o.noFO === currentOrderNoFO);

            if (orderIndex >= 0) {
                if (!archive[orderIndex].signedSPV) {
                    alert('SPV harus TTD terlebih dahulu!');
                    return;
                }

                archive[orderIndex].signedManager = true;
                archive[orderIndex].sigManager = signaturePadManagerDetail.toDataURL();
                archive[orderIndex].managerSignedAt = new Date().toISOString();
                localStorage.setItem('fo_archive', JSON.stringify(archive));

                alert('TTD Manager berhasil disimpan! Semua approval lengkap.');

                // Refresh modal dan arsip
                closeOrderDetail();
                showArchive();
                openOrderDetail(currentOrderNoFO);
            }
        }

        function regeneratePDF() {
            if (!currentOrderNoFO) return;

            const archive = JSON.parse(localStorage.getItem('fo_archive') || '[]');
            const order = archive.find(o => o.noFO === currentOrderNoFO);

            if (!order) {
                alert('Order not found!');
                return;
            }

            // Get selected company (default to UBB if not set)
            const selectedCompany = order.company || 'UBB';
            const companyInfo = COMPANY_INFO[selectedCompany];

            // Load appropriate logo from cache
            let currentLogo = null;
            if (selectedCompany === 'MBB') {
                if (!logoMBB) {
                    logoMBB = localStorage.getItem('fo_logo_mbb_base64');
                }
                currentLogo = logoMBB;
            } else {
                if (!logoBase64) {
                    logoBase64 = localStorage.getItem('fo_logo_base64');
                }
                currentLogo = logoBase64;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const margin = 15;

            // ========== HEADER SECTION ==========
            // Logo on the left
            if (currentLogo) {
                doc.addImage(currentLogo, 'PNG', margin, 12, 35, 25);
            }

            // Title "Form Order" on top right
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0); // Black
            doc.text('Form Order', pageWidth - margin, 20, { align: 'right' });

            // Reference info on the right (without labels)
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.text(order.noFO, pageWidth - margin, 30, { align: 'right' });
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(new Date(order.tanggal).toLocaleDateString('en-GB'), pageWidth - margin, 36, { align: 'right' });

            // ========== COMPANY & CUSTOMER INFO (2 columns) ==========
            const infoY = 50;

            // Left column - Company Info
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.text('Company Info', margin, infoY);

            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            doc.line(margin, infoY + 2, 90, infoY + 2);

            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text(companyInfo.name, margin, infoY + 10);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(0, 0, 0);
            doc.text(companyInfo.address1, margin, infoY + 16);
            doc.text(companyInfo.address2, margin, infoY + 21);
            doc.text(companyInfo.address3, margin, infoY + 26);
            doc.text(companyInfo.email, margin, infoY + 33);

            // Right column - Order To (Customer)
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.text('Order To', 110, infoY);

            doc.line(110, infoY + 2, pageWidth - margin, infoY + 2);

            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text(order.customer, 110, infoY + 10);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(0, 0, 0);
            const alamatLines = doc.splitTextToSize(order.alamat, 80);
            let alamatY = infoY + 16;
            alamatLines.forEach((line, i) => {
                if (i < 3) {
                    doc.text(line, 110, alamatY);
                    alamatY += 5;
                }
            });
            doc.text(`Phone: ${order.hp}`, 110, alamatY + 3);

            // ========== TABLE SECTION ==========
            const tableStartY = 95;

            // Prepare table data - columns: SKU, Product, Qty, Original Price, Discount, After Discount, Total
            const tableBody = [];
            if (order.orderItems && order.orderItems.length > 0) {
                order.orderItems.forEach((item, index) => {
                    const isNewFormat = item.length === 9;
                    let sku, nama, gender, price, discount, hargaDiskon, qty, subtotal;

                    if (isNewFormat) {
                        // Format: No, SKU, Nama, Gender, Price, Diskon, Harga Diskon, Qty, Subtotal
                        sku = item[1];
                        nama = item[2];
                        gender = item[3];
                        price = item[4];
                        discount = item[5];
                        hargaDiskon = item[6];
                        qty = item[7];
                        subtotal = item[8];
                    } else {
                        // Format: No, SKU, Nama, Gender, Diskon, Harga, Qty, Subtotal
                        sku = item[1];
                        nama = item[2];
                        gender = item[3];
                        discount = item[4];
                        hargaDiskon = item[5];
                        qty = item[6];
                        subtotal = item[7];
                        price = '-';
                    }

                    tableBody.push([
                        sku,
                        { content: `${nama}\n${gender}`, styles: { fontStyle: 'normal' } },
                        qty,
                        price,
                        discount,
                        hargaDiskon,
                        subtotal
                    ]);
                });
            }

            doc.autoTable({
                startY: tableStartY,
                head: [['SKU', 'Product', 'Qty', 'Price', 'Disc', 'After Disc', 'Total']],
                body: tableBody,
                theme: 'plain',
                headStyles: {
                    fillColor: [31, 78, 120],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 8,
                    halign: 'center',
                    cellPadding: 3
                },
                styles: {
                    fontSize: 7,
                    cellPadding: 4,
                    lineColor: [220, 220, 220],
                    lineWidth: 0.1
                },
                columnStyles: {
                    0: { cellWidth: 22, halign: 'left' },      // SKU
                    1: { cellWidth: 50, halign: 'left' },      // Product
                    2: { cellWidth: 15, halign: 'center' },    // Qty
                    3: { cellWidth: 25, halign: 'right' },     // Original Price
                    4: { cellWidth: 15, halign: 'center' },    // Discount
                    5: { cellWidth: 25, halign: 'right' },     // After Discount
                    6: { cellWidth: 28, halign: 'right' }      // Total
                },
                alternateRowStyles: {
                    fillColor: [250, 250, 250]
                },
                didDrawCell: function(data) {
                    // Draw bottom border for each row
                    if (data.section === 'body') {
                        doc.setDrawColor(220, 220, 220);
                        doc.setLineWidth(0.3);
                        doc.line(data.cell.x, data.cell.y + data.cell.height,
                                 data.cell.x + data.cell.width, data.cell.y + data.cell.height);
                    }
                }
            });

            // ========== TOTALS SECTION (Right aligned with table Total column) ==========
            const totalsStartY = doc.lastAutoTable.finalY + 10;
            // Align with Total column: margin + all columns (180) - cellPadding (4)
            const totalColRightEdge = margin + 180 - 4;

            // Calculate total qty
            let totalQty = 0;
            if (order.orderItems && order.orderItems.length > 0) {
                order.orderItems.forEach(item => {
                    const isNewFormat = item.length === 9;
                    const qtyIndex = isNewFormat ? 7 : 6;
                    const qtyStr = item[qtyIndex].toString().replace(/[^0-9]/g, '');
                    totalQty += parseInt(qtyStr) || 0;
                });
            }

            // Total Qty
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Total Qty:', totalColRightEdge - 50, totalsStartY);
            doc.setFontSize(10);
            doc.text(`${totalQty} Box`, totalColRightEdge, totalsStartY, { align: 'right' });

            // Grand Total
            const grandTotalY = totalsStartY + 7;
            doc.setFontSize(9);
            doc.text('Grand Total:', totalColRightEdge - 50, grandTotalY);
            doc.setFontSize(10);
            doc.text(`Rp ${order.totalAmount.toLocaleString('id-ID')}`, totalColRightEdge, grandTotalY, { align: 'right' });

            // ========== SIGNATURES SECTION ==========
            const sigY = grandTotalY + 20;

            const boxWidth = 50;
            const boxHeight = 20;
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.2);

            // ===== ROW 1: Customer (left) & SPV (right) =====
            const row1CustX = 55;  // Customer center position
            const row1SpvX = 155;  // SPV center position

            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.text('Prepared by', row1CustX, sigY, { align: 'center' });
            doc.text('Approved by', row1SpvX, sigY, { align: 'center' });

            // Customer signature
            if (order.sigCustomer) {
                doc.addImage(order.sigCustomer, 'PNG', row1CustX - 25, sigY + 3, boxWidth, boxHeight);
            } else {
                doc.rect(row1CustX - 25, sigY + 3, boxWidth, boxHeight);
            }

            // SPV signature
            if (order.signedSPV && order.sigSPV) {
                doc.addImage(order.sigSPV, 'PNG', row1SpvX - 25, sigY + 3, boxWidth, boxHeight);
            } else {
                doc.rect(row1SpvX - 25, sigY + 3, boxWidth, boxHeight);
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text('(Not signed yet)', row1SpvX, sigY + 15, { align: 'center' });
            }

            // Names & Titles for Row 1
            const nameY1 = sigY + 28;
            const titleY1 = nameY1 + 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            const custName = order.nameCustomer || order.customer;
            const spvName = order.nameSPV || 'Ni Luh Kade Yuliani';
            doc.text(`(${custName})`, row1CustX, nameY1, { align: 'center' });
            doc.text(`(${spvName})`, row1SpvX, nameY1, { align: 'center' });

            // Lines above job titles
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            doc.line(row1CustX - 25, nameY1 + 2, row1CustX + 25, nameY1 + 2);
            doc.line(row1SpvX - 25, nameY1 + 2, row1SpvX + 25, nameY1 + 2);

            doc.setFontSize(9);
            doc.text('Customer', row1CustX, titleY1 + 2, { align: 'center' });
            doc.text('SPV Wholesale', row1SpvX, titleY1 + 2, { align: 'center' });

            // ===== ROW 2: Branch Manager (center) =====
            const row2Y = titleY1 + 12;
            const row2MgrX = 105;  // Center of page

            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.text('Acknowledged by', row2MgrX, row2Y, { align: 'center' });

            // Manager signature
            if (order.signedManager && order.sigManager) {
                doc.addImage(order.sigManager, 'PNG', row2MgrX - 25, row2Y + 3, boxWidth, boxHeight);
            } else {
                doc.rect(row2MgrX - 25, row2Y + 3, boxWidth, boxHeight);
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text('(Not signed yet)', row2MgrX, row2Y + 15, { align: 'center' });
            }

            // Name & Title for Row 2
            const nameY2 = row2Y + 28;
            const titleY2 = nameY2 + 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            const mgrName = order.nameManager || 'Budy';
            doc.text(`(${mgrName})`, row2MgrX, nameY2, { align: 'center' });

            // Line above job title
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            doc.line(row2MgrX - 25, nameY2 + 2, row2MgrX + 25, nameY2 + 2);

            doc.setFontSize(9);
            doc.text('Branch Manager BD & Wholesale', row2MgrX, titleY2 + 2, { align: 'center' });

            // ========== SAVE PDF ==========
            const statusSuffix = (order.signedSPV && order.signedManager) ? '_APPROVED' : '_PENDING';
            const filename = `FO_${order.noFO}_${order.customer.replace(/\s+/g, '_')}${statusSuffix}.pdf`;
            doc.save(filename);

            alert(`PDF generated: ${filename}`);
        }

        // ========================================
        // AUTHENTICATION SYSTEM
        // ========================================

        let currentUser = null;

        // Default users (admin harus ganti password setelah setup)
        const DEFAULT_USERS = [
            { username: 'admin', password: 'admin123', role: 'admin', name: 'Administrator' },
            { username: 'spv', password: 'spv123', role: 'spv', name: 'SPV Wholesale' },
            { username: 'manager', password: 'manager123', role: 'manager', name: 'Branch Manager' },
            { username: 'cs', password: 'cs123', role: 'customer', name: 'Customer Service' }
        ];

        function initUsers() {
            let users = JSON.parse(localStorage.getItem('fo_users') || 'null');
            if (!users) {
                // First time - create default users
                localStorage.setItem('fo_users', JSON.stringify(DEFAULT_USERS));
                console.log('Default users created');
            } else {
                // Check if any default users are missing and add them
                let updated = false;
                DEFAULT_USERS.forEach(defaultUser => {
                    if (!users.find(u => u.username === defaultUser.username)) {
                        users.push(defaultUser);
                        updated = true;
                    }
                });
                if (updated) {
                    localStorage.setItem('fo_users', JSON.stringify(users));
                    console.log('New default users added');
                }
            }
        }

        function getUsers() {
            return JSON.parse(localStorage.getItem('fo_users') || '[]');
        }

        function saveUsers(users) {
            localStorage.setItem('fo_users', JSON.stringify(users));
        }

        function doLogin() {
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Username dan password harus diisi!';
                errorDiv.style.display = 'block';
                return;
            }

            const users = getUsers();
            const user = users.find(u => u.username.toLowerCase() === username && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('fo_current_user', JSON.stringify(user));
                errorDiv.style.display = 'none';
                showApp();
            } else {
                errorDiv.textContent = 'Username atau password salah!';
                errorDiv.style.display = 'block';
            }
        }

        function doLogout() {
            if (confirm('Yakin ingin logout?')) {
                currentUser = null;
                localStorage.removeItem('fo_current_user');
                hideApp();
            }
        }

        function showApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';

            // Update user info display
            const roleNames = {
                'admin': 'üëë Admin',
                'spv': 'üìã SPV Wholesale',
                'manager': 'üëî Branch Manager',
                'customer': 'üë§ Customer'
            };
            document.getElementById('userInfo').innerHTML = `
                <strong>${currentUser.name}</strong><br>
                <span style="opacity: 0.8;">${roleNames[currentUser.role] || currentUser.role}</span>
            `;

            // Apply role-based UI
            applyRoleBasedUI();
        }

        function hideApp() {
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        function applyRoleBasedUI() {
            if (!currentUser) return;

            const role = currentUser.role;

            // Customer: Hanya bisa buat order, tidak bisa akses arsip detail untuk TTD SPV/Manager
            // SPV: Bisa TTD SPV
            // Manager: Bisa TTD Manager
            // Admin: Bisa semua

            // Show/hide admin button
            const adminBtn = document.getElementById('adminBtn');
            if (adminBtn) {
                adminBtn.style.display = (role === 'admin') ? 'inline-block' : 'none';
            }

            console.log(`Role-based UI applied for: ${role}`);
        }

        function canSignAs(signRole) {
            if (!currentUser) return false;
            const role = currentUser.role;

            // Admin bisa semua
            if (role === 'admin') return true;

            // Customer hanya bisa TTD customer (saat generate PDF)
            if (signRole === 'customer') return true;

            // SPV hanya bisa TTD SPV
            if (signRole === 'spv' && role === 'spv') return true;

            // Manager hanya bisa TTD Manager
            if (signRole === 'manager' && role === 'manager') return true;

            return false;
        }

        // ========== ADMIN PANEL FUNCTIONS ==========
        function openAdminPanel() {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Akses ditolak! Hanya admin yang bisa mengakses.');
                return;
            }
            document.getElementById('adminModal').style.display = 'block';
            renderUserList();
        }

        function closeAdminPanel() {
            document.getElementById('adminModal').style.display = 'none';
            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newRole').value = '';
        }

        function renderUserList() {
            const users = getUsers();
            const container = document.getElementById('userList');

            const roleLabels = {
                'admin': 'üëë Admin',
                'spv': 'üìã SPV Wholesale',
                'manager': 'üëî Branch Manager',
                'customer': 'üë§ Customer'
            };

            const roleColors = {
                'admin': '#9b59b6',
                'spv': '#3498db',
                'manager': '#e67e22',
                'customer': '#27ae60'
            };

            let html = '';
            users.forEach((user, index) => {
                const isDefault = DEFAULT_USERS.find(u => u.username === user.username);
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 8px;">
                        <div>
                            <strong style="font-size: 15px;">${user.name}</strong>
                            <span style="display: inline-block; background: ${roleColors[user.role] || '#666'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">${roleLabels[user.role] || user.role}</span>
                            <br>
                            <span style="color: #888; font-size: 12px;">@${user.username}</span>
                            ${isDefault ? '<span style="color: #999; font-size: 11px; margin-left: 10px;">(Default)</span>' : ''}
                        </div>
                        <div>
                            <button onclick="resetPassword('${user.username}')" style="background: #f39c12; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-right: 5px; font-size: 12px;">üîë Reset Password</button>
                            ${!isDefault ? `<button onclick="deleteUser('${user.username}')" style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">üóëÔ∏è Hapus</button>` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<p style="color: #888; text-align: center;">Tidak ada user</p>';
        }

        function addUser() {
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newPassword').value;
            const name = document.getElementById('newName').value.trim();
            const role = document.getElementById('newRole').value;

            if (!username || !password || !name || !role) {
                alert('Semua field harus diisi!');
                return;
            }

            if (username.length < 3) {
                alert('Username minimal 3 karakter!');
                return;
            }

            if (password.length < 4) {
                alert('Password minimal 4 karakter!');
                return;
            }

            const users = getUsers();
            if (users.find(u => u.username === username)) {
                alert('Username sudah digunakan!');
                return;
            }

            users.push({ username, password, role, name });
            localStorage.setItem('fo_users', JSON.stringify(users));

            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newRole').value = '';

            renderUserList();
            alert('User berhasil ditambahkan!');
        }

        function deleteUser(username) {
            if (!confirm(`Yakin ingin menghapus user "${username}"?`)) return;

            let users = getUsers();
            users = users.filter(u => u.username !== username);
            localStorage.setItem('fo_users', JSON.stringify(users));

            renderUserList();
            alert('User berhasil dihapus!');
        }

        function resetPassword(username) {
            const newPassword = prompt(`Masukkan password baru untuk "${username}":`);
            if (!newPassword) return;

            if (newPassword.length < 4) {
                alert('Password minimal 4 karakter!');
                return;
            }

            let users = getUsers();
            const userIndex = users.findIndex(u => u.username === username);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                localStorage.setItem('fo_users', JSON.stringify(users));
                alert('Password berhasil direset!');
            }
        }

        function checkAuth() {
            initUsers();

            // Check if user is already logged in
            const savedUser = localStorage.getItem('fo_current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                // Verify user still exists
                const users = getUsers();
                const userExists = users.find(u => u.username === currentUser.username);
                if (userExists) {
                    showApp();
                    return;
                }
            }

            // Not logged in - show login
            hideApp();
        }

        // Handle Enter key on login form
        document.getElementById('loginPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') doLogin();
        });
        document.getElementById('loginUsername').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') document.getElementById('loginPassword').focus();
        });

        // Check authentication on page load
        checkAuth();
    </script>
    </div><!-- End mainApp -->
</body>
</html>
